<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — 사용법</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="preload" as="image" href="/images/mm_logo_small.jpg" />
  <style>
    :root { --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --pri:#5eead4; --border:#1e2230; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#e7edf5}
    a{color:var(--pri);text-decoration:none} a:hover{text-decoration:underline}
    header,main,footer{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-img{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1422}
    nav a{margin-left:16px;color:#cfd6e4}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:8px 0 2px;font-size:22px}
    p.muted{color:var(--muted);margin:2px 0 0}
    .howtouse{ margin-top:10px; }
    .howtouse-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    @media (max-width:1024px){ .howtouse-grid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .howtouse-grid{ grid-template-columns:1fr;} }
    .howtouse-item{ position:relative; display:block; border-radius:10px; overflow:hidden; background:#0f1320; aspect-ratio:1/2; border:1px solid var(--border); }
    .howtouse-item img{ width:100%; height:100%; object-fit:cover; display:block; image-rendering:auto; transition:transform .2s ease-out, opacity .2s ease-out; opacity:.98; }
    .howtouse-item:hover img{ transform:scale(1.02); opacity:1; }
    .overlay{ position:absolute; inset:0; pointer-events:none; }
    .olabel{ position:absolute; white-space:pre-wrap; color:#000; text-shadow:none; filter:none; }
    .anchor-topstart{ transform: translate(0,0); }
    .anchor-topcenter{ transform: translate(-50%,0); left:50%; }
    .anchor-topend{ transform: translate(-100%,0); }
    .debug .olabel { outline:1px dashed rgba(0,0,0,.35); }
    footer{margin:30px auto 60px;text-align:center;color:var(--muted);font-size:14px}
    /* JS 작동 확인용 토스트 */
    #ping{position:fixed;top:8px;right:8px;background:#16a34a;color:#fff;padding:6px 10px;border-radius:8px;z-index:99999;font:12px/1 system-ui}
  </style>
<style>
  /* 03~06만 원본 비율 유지(크롭 금지) */
  .howtouse-item.ratio-free{ aspect-ratio: unset !important; }
  .howtouse-item.ratio-free img{
    height: auto !important;
    object-fit: contain !important; /* cover → contain */
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo_small.jpg" alt="Measure Master" class="logo-img" width="28" height="28"
         loading="eager" fetchpriority="high"
         onerror="this.onerror=null; this.src='/images/mm_logo_small.png';" />
    <strong>Measure Master</strong>
  </div>
  <nav>
    <a href="/">홈</a>
    <a href="/howtouse.html">사용법</a>
    <a href="/reviews.html">사용후기</a>
    <a href="/privacy.html">개인정보처리방침</a>
  </nav>
</header>

<main>
  <section class="card howtouse">
    <h1>사용법</h1>
    <p class="muted">총 22장 · 이미지를 탭하면 원본이 새 탭에서 열립니다.</p>
    <div id="howtoGrid" class="howtouse-grid"></div>
  </section>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<script>
/* ===================== howtouse: render + editor (Alt+Shift+C 지원) ===================== */
(function(){
  /* ---------- 기본 상수(필요시 버전 쿼리만 올려 캐시 무력화) ---------- */
  const IMG_DIR       = "/images/howtouse";
  const IMG_PREFIX    = "howtouse";
  const IMG_EXTS      = ["jpg","png","jpeg","webp"];
  const TOTAL_PAGES   = 22;
  const OVERLAYS_JSON = "/assets/data/howtouse_overlays_pc.json?v=pc13";
  const STRINGS_KO    = "/assets/data/strings_ko_pc.json?v=pc13";
  const BASE_H        = 600;  // dx/dy 기준 높이

  document.getElementById('year').textContent = new Date().getFullYear();

  /* ---------- 유틸 ---------- */
  function showError(msg){
    let bar = document.getElementById("errbar");
    if(!bar){
      bar = document.createElement("div");
      bar.id="errbar";
      bar.style.cssText="position:sticky;top:0;z-index:9999;background:#ff3b30;color:#fff;padding:10px 14px;border-radius:10px;margin:10px 0";
      (document.querySelector("main .card")||document.body).prepend(bar);
    }
    bar.textContent = msg;
    console.error("[howtouse]", msg);
  }
  async function loadJson(url){
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} @ ${res.url}`);
    try{ return await res.json(); }
    catch(e){ throw new Error(`JSON parse error @ ${url}: ${e.message}`); }
  }
  function parseColorHex(hex){
    if(!hex) return null;
    let s = String(hex).trim();
    if(s.startsWith("0x")) s=s.slice(2);
    if(s.startsWith("#")) s=s.slice(1);
    if(s.length===8){
      const a=parseInt(s.slice(0,2),16)/255, r=parseInt(s.slice(2,4),16), g=parseInt(s.slice(4,6),16), b=parseInt(s.slice(6,8),16);
      return `rgba(${r},${g},${b},${a})`;
    }else if(s.length===6){
      const r=parseInt(s.slice(0,2),16), g=parseInt(s.slice(2,4),16), b=parseInt(s.slice(4,6),16);
      return `rgb(${r},${g},${b})`;
    }
    return null;
  }
  function anchorClass(align="TopStart"){
    const a=String(align||'').toLowerCase();
    if(a.includes("center")) return "anchor-topcenter";
    if(a.includes("end"))    return "anchor-topend";
    return "anchor-topstart";
  }
  function createImageWithFallback(num){
    const img = new Image();
    img.alt = `사용법 ${num}`;
    img.loading = "lazy";
    const base = `${IMG_DIR}/${IMG_PREFIX}${num}`;
    let i=0;
    img.onerror = ()=> {
      if(i<IMG_EXTS.length){ img.src = `${base}.${IMG_EXTS[i++]}`; }
      else{
        img.onerror = null;
        img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="1200"><rect width="100%" height="100%" fill="%230f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" opacity="0.4" font-size="20">이미지 없음</text></svg>';
      }
    };
    img.src = `${base}.${IMG_EXTS[i++]}`;
    return img;
  }

  /* ---------- 오버레이 렌더 ---------- */
  function layoutLabels($item, labels){
    let $overlay = $item.querySelector(".overlay");
    if(!$overlay){ $overlay = document.createElement("div"); $overlay.className="overlay"; $item.appendChild($overlay); }
    if(!labels?.length){ $overlay.innerHTML=""; return; }

    $overlay.innerHTML = "";
    const rect = $item.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    const scale = H/BASE_H;

    labels.forEach(cfg=>{
      const el = document.createElement("div");
      el.className = "olabel " + anchorClass(cfg.align);
      const text = (window.__STRINGS && window.__STRINGS[cfg.key]) || cfg.key;
      el.textContent = text;

      if(cfg.bold) el.style.fontWeight="700";
      if(cfg.sizeSp)       el.style.fontSize   = `${cfg.sizeSp}px`;
      if(cfg.lineHeightSp) el.style.lineHeight = `${cfg.lineHeightSp}px`;
      if(cfg.textAlign)    el.style.textAlign  = ({"Center":"center","End":"right","Start":"left"}[cfg.textAlign] || "left");
      const col = parseColorHex(cfg.colorHex); if(col) el.style.color = col;
      if(cfg.maxWidthPercent) el.style.maxWidth = `${cfg.maxWidthPercent*W}px`;

      if(typeof cfg.xPercent==="number" && typeof cfg.yPercent==="number"){
        el.style.left = `${cfg.xPercent*100}%`;
        el.style.top  = `${cfg.yPercent*100}%`;
      }else{
        const dx=(cfg.dx||0)*scale, dy=(cfg.dy||0)*scale;
        const a=(cfg.align||"").toLowerCase();
        let leftPx = a.includes("center") ? W/2 + dx : a.includes("end") ? W + dx : dx;
        el.style.left = `${leftPx}px`;
        el.style.top  = `${dy}px`;
      }
      $overlay.appendChild(el);
    });
  }
  function buildOverlayMap(pages){
    const map={};
    (pages||[]).forEach(group=>{
      const any = group.find(it=>/^htu(\d{2})_/.test(it.key));
      if(any){ const num = any.key.match(/^htu(\d{2})_/)[1]; map[num]=group; }
    });
    return map;
  }

  /* ---------- 초기화: JSON 로드 → 그리드 생성 ---------- */
  let overlayData=null, map=null;
  (async function init(){
    try{
      const [ov, ko] = await Promise.all([loadJson(OVERLAYS_JSON), loadJson(STRINGS_KO).catch(()=>null)]);
      overlayData = ov;
      map = buildOverlayMap(ov.pages);
      window.__STRINGS = ko || {};
    }catch(e){
      showError(e.message);
      return;
    }
    if(!map){ showError("오버레이 데이터 형식 오류: pages 배열이 없습니다."); return; }

const grid = document.getElementById("howtoGrid") || document.querySelector(".howto-grid");
    grid.innerHTML = "";
    for(let i=1;i<=TOTAL_PAGES;i++){
      const num = String(i).padStart(2,"0");

      if (["03","04","05","06"].includes(num)) a.classList.add("ratio-free");

      const a = document.createElement("a");
      a.className = "howtouse-item";
      a.target="_blank"; a.rel="noopener";
      a.href = `${IMG_DIR}/${IMG_PREFIX}${num}.jpg`;

      const img = createImageWithFallback(num);
      a.appendChild(img);
      const ol  = document.createElement("div"); ol.className="overlay"; a.appendChild(ol);
      grid.appendChild(a);

      const labels = map[num];
      if(!labels){
        const warn = document.createElement("div");
        warn.className = "olabel anchor-topcenter";
        warn.style.cssText="left:50%;top:10px;font-size:14px;color:#d00";
        warn.textContent = `⚠ 오버레이 없음 (htu${num}_* 키 확인)`;
        ol.appendChild(warn);
      }else{
        layoutLabels(a, labels);
        new ResizeObserver(()=> layoutLabels(a, labels)).observe(a);
      }
    }
  })();

  /* ================================== 편집 모드 (?edit=1) ================================== */
  (function editor(){
    const params = new URLSearchParams(location.search);
    if (params.get('edit') !== '1') return;

    // 편집 모드용 CSS: 라벨 클릭 허용 + 시각 피드백
    document.body.classList.add('edit-mode');
    const style = document.createElement('style');
    style.textContent = [
      '.edit-mode .overlay{pointer-events:auto}',
      '.edit-mode .olabel{cursor:pointer;outline:1px dashed rgba(0,0,0,.35)}',
      '.edit-mode .olabel:hover{outline:2px solid #5eead4}'
    ].join('');
    document.head.appendChild(style);

    // 카드 <a> 클릭으로 원본 이미지로 이동하는 동작 차단
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('.howtouse-item');
      if (a) { e.preventDefault(); e.stopPropagation(); }
    }, true);

    // HUD
    const hud = document.createElement('div');
    hud.style.cssText = "position:fixed;top:8px;right:8px;z-index:99999;background:#0b0d12dd;color:#fff;border:1px solid #1e2230;padding:10px 12px;border-radius:10px;font:12px/1.4 system-ui;max-width:40ch";
    hud.innerHTML = '' +
      '<div style="font-weight:700;margin-bottom:6px">Overlay Editor</div>' +
      '<div id="ed-info" style="white-space:pre-wrap;margin-bottom:8px"></div>' +
      '<div style="display:flex;gap:6px;flex-wrap:wrap">' +
      '  <button id="btn-copy-one"  style="cursor:pointer;padding:6px 8px;border-radius:8px;border:1px solid #1e2230;background:#121622;color:#fff">선택 라벨 복사 (C)</button>' +
      '  <button id="btn-copy-page" style="cursor:pointer;padding:6px 8px;border-radius:8px;border:1px solid #1e2230;background:#121622;color:#fff">이 페이지 복사 (Shift+C)</button>' +
      '  <button id="btn-copy-all"  style="cursor:pointer;padding:6px 8px;border-radius:8px;border:1px solid #1e2230;background:#121622;color:#fff">전체 복사 (Alt+Shift+C)</button>' +
      '</div>';
    document.body.appendChild(hud);
    const info = hud.querySelector('#ed-info');

    let selected = null; // {el, cfg, pageNum, card, uses:'percent'|'offset'}

    // 라벨 클릭 → 선택
    document.addEventListener('click', e=>{
      const label = e.target.closest('.olabel');
      if (!label) return;

      document.querySelectorAll('.olabel').forEach(n=>n.style.outline='1px dashed rgba(0,0,0,.35)');
      label.style.outline = '2px solid #5eead4';

      const card = label.closest('.howtouse-item');
      const a = card?.tagName==='A' ? card : card?.closest('a');
      let pageNum = null;
      if (a?.href) {
        const m = a.href.match(/howtouse(\d{2})\./);
        if (m) pageNum = m[1];
      }
      if (!pageNum) {
        const m2 = card?.querySelector('img')?.alt?.match(/(\d{2})/);
        if (m2) pageNum = m2[1];
      }
      if (!pageNum || !map?.[pageNum]) { info.textContent = '이 카드의 오버레이 그룹을 찾지 못했습니다.'; return; }

      // 화면 좌표에 가장 가까운 cfg 선택
      const rect = card.getBoundingClientRect();
      const W=rect.width, H=rect.height;
      const left = parseFloat(label.style.left)||0;
      const top  = parseFloat(label.style.top)||0;

      let best=null, bestDist=Infinity;
      for(const cfg of map[pageNum]){
        let cx, cy;
        if (typeof cfg.xPercent==='number' && typeof cfg.yPercent==='number') {
          cx = cfg.xPercent*W; cy = cfg.yPercent*H;
        } else {
          const al = String(cfg.align||'').toLowerCase();
          const base = al.includes('center') ? W/2 : al.includes('end') ? W : 0;
          const scale = H/BASE_H;
          cx = base + (cfg.dx||0)*scale;
          cy = (cfg.dy||0)*scale;
        }
        const d = Math.hypot(left-cx, top-cy);
        if (d<bestDist){ bestDist=d; best=cfg; }
      }

      if (!best){ info.textContent = '라벨 cfg를 찾지 못했습니다.'; return; }

      selected = {
        el: label,
        cfg: best,
        pageNum,
        card,
        uses: (typeof best.xPercent==='number' && typeof best.yPercent==='number') ? 'percent' : 'offset'
      };
      updateHUD();
    }, true);

    function updateHUD(){
      if (!selected){ info.textContent = '라벨을 클릭해서 선택하세요.'; return; }
      const {cfg, pageNum, uses} = selected;
      info.textContent =
`page: ${pageNum}
key : ${cfg.key}
mode: ${uses==='percent' ? 'xPercent/yPercent' : 'dx/dy'}
size: ${cfg.sizeSp ?? '(default)'}  line: ${cfg.lineHeightSp ?? '(default)'}
maxW: ${cfg.maxWidthPercent ?? '(none)'}  align: ${cfg.align ?? 'TopStart'}

C = 선택 라벨 JSON 복사
Shift+C = 현재 페이지 그룹 복사
Alt+Shift+C = 전체 pages 복사`;
    }

    function cleanCfg(cfg){
      const out = { key: cfg.key, align: cfg.align||'TopStart', textAlign: cfg.textAlign||'Start', bold: !!cfg.bold };
      if (typeof cfg.sizeSp==='number') out.sizeSp = Math.round(cfg.sizeSp);
      if (typeof cfg.lineHeightSp==='number') out.lineHeightSp = Math.round(cfg.lineHeightSp);
      if (typeof cfg.maxWidthPercent==='number') out.maxWidthPercent = +cfg.maxWidthPercent.toFixed(4);
      if (cfg.colorHex) out.colorHex = cfg.colorHex;

      if (typeof cfg.xPercent==='number' && typeof cfg.yPercent==='number'){
        out.xPercent = +cfg.xPercent.toFixed(4);
        out.yPercent = +cfg.yPercent.toFixed(4);
      } else {
        out.dx = Math.round(cfg.dx || 0);
        out.dy = Math.round(cfg.dy || 0);
      }
      return out;
    }
    function snippetOne(cfg){ return JSON.stringify(cleanCfg(cfg), null, 2); }
    function snippetPage(num){
      const group = map?.[num]; if(!group) return null;
      return JSON.stringify(group.map(cleanCfg), null, 2);
    }
    function snippetAll(){
      if (!overlayData?.pages) return null;
      const pages = overlayData.pages.map(group => group.map(cleanCfg));
      return JSON.stringify({ pages }, null, 2);
    }
    function copy(txt, label){
      return navigator.clipboard.writeText(txt).then(()=>{
        info.textContent = `✔ ${label} 복사됨\n\n${txt.slice(0,500)}${txt.length>500?'…':''}`;
      });
    }

    // 키보드: 이동/크기/폭% + 복사(C, Shift+C, Alt+Shift+C)
    document.addEventListener('keydown', (e)=>{
      if (!selected) {
        // 복사 핫키는 선택 없어도 전체 복사만 허용
        if (e.key.toLowerCase()==='c' && e.altKey && e.shiftKey && !e.ctrlKey && !e.metaKey){
          const all = snippetAll(); if (all){ e.preventDefault(); copy(all, '전체 pages'); }
        }
        return;
      }
      const step = e.shiftKey ? 5 : 1;
      const {el, card, cfg, uses} = selected;
      const rect = card.getBoundingClientRect();
      const W=rect.width, H=rect.height, scale=H/BASE_H;

      let dirty=false, k=e.key;

      if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(k)){
        e.preventDefault();
        const dxp = k==='ArrowLeft'?-step : k==='ArrowRight'?step : 0;
        const dyp = k==='ArrowUp'  ?-step : k==='ArrowDown'?step : 0;
        if (uses==='percent'){
          cfg.xPercent = (cfg.xPercent||0) + dxp/W;
          cfg.yPercent = (cfg.yPercent||0) + dyp/H;
          el.style.left = `${cfg.xPercent*100}%`;
          el.style.top  = `${cfg.yPercent*100}%`;
        } else {
          cfg.dx = Math.round((cfg.dx||0) + dxp/scale);
          cfg.dy = Math.round((cfg.dy||0) + dyp/scale);
          const a = String(cfg.align||'').toLowerCase();
          const base = a.includes('center') ? W/2 : a.includes('end') ? W : 0;
          el.style.left = `${base + (cfg.dx||0)*scale}px`;
          el.style.top  = `${(cfg.dy||0)*scale}px`;
        }
        dirty=true;
      }
      if (k==='+' || k==='='){ cfg.sizeSp=(cfg.sizeSp||12)+1; el.style.fontSize=`${cfg.sizeSp}px`; dirty=true; }
      if (k==='-'){ cfg.sizeSp=(cfg.sizeSp||12)-1; el.style.fontSize=`${cfg.sizeSp}px`; dirty=true; }
      if (k===';'){ cfg.lineHeightSp=(cfg.lineHeightSp||(cfg.sizeSp||12))-1; el.style.lineHeight=`${cfg.lineHeightSp}px`; dirty=true; }
      if (k==="'"){ cfg.lineHeightSp=(cfg.lineHeightSp||(cfg.sizeSp||12))+1; el.style.lineHeight=`${cfg.lineHeightSp}px`; dirty=true; }
      if (k==='['){ cfg.maxWidthPercent=Math.max(0, +(cfg.maxWidthPercent||0)-0.01); el.style.maxWidth=`${cfg.maxWidthPercent*W}px`; dirty=true; }
      if (k===']'){ cfg.maxWidthPercent=Math.min(1, +(cfg.maxWidthPercent||0)+0.01); el.style.maxWidth=`${cfg.maxWidthPercent*W}px`; dirty=true; }

      // 복사
      if (k.toLowerCase()==='c'){
        const ctrl=e.ctrlKey||e.metaKey, alt=e.altKey, shift=e.shiftKey;
        if (alt && shift && !ctrl){ // Alt+Shift+C: 전체
          const all = snippetAll(); if (all){ e.preventDefault(); copy(all, '전체 pages'); }
        } else if (shift && !alt && !ctrl){ // Shift+C: 페이지
          const js = snippetPage(selected.pageNum); if(js){ e.preventDefault(); copy(js, `페이지 ${selected.pageNum}`); }
        } else if (!alt && !shift && !ctrl){ // C: 선택 라벨
          e.preventDefault(); copy(snippetOne(selected.cfg), '선택 라벨');
        }
      }

      if (dirty) updateHUD();
    }, true);

    // 버튼 핸들러
    document.getElementById('btn-copy-one') .addEventListener('click', ()=>{
      if (!selected) { info.textContent='먼저 라벨을 선택하세요.'; return; }
      copy(snippetOne(selected.cfg), '선택 라벨');
    });
    document.getElementById('btn-copy-page').addEventListener('click', ()=>{
      if (!selected) { info.textContent='먼저 라벨을 하나 선택(이 페이지 판별용)하세요.'; return; }
      const js = snippetPage(selected.pageNum); if (js) copy(js, `페이지 ${selected.pageNum}`);
    });
    document.getElementById('btn-copy-all') .addEventListener('click', ()=>{
      const all = snippetAll(); if (all) copy(all, '전체 pages');
    });

    // 모드 배지
    const tag = document.createElement('div');
    tag.textContent = 'EDIT MODE';
    tag.style.cssText = 'position:fixed;bottom:10px;right:10px;background:#f59e0b;color:#000;padding:4px 8px;border-radius:6px;font:11px/1 system-ui;z-index:99999';
    document.body.appendChild(tag);
  })();
})();
</script>

<script>
/* Drop-in patch: 03~06만 dx/dy → xPercent/yPercent 변환 (원본 코드 무변경) */
(function(){
  const TARGETS = new Set(["03","04","05","06"]);
  const BASE_H = 600; // 메인 스크립트의 BASE_H와 동일해야 합니다.

  function getPageNumFromItem(item){
    const a = item.closest('a.howtouse-item') || item;
    const href = a.getAttribute('href') || '';
    let m = href.match(/howtouse(\d{2})\./);
    if (m) return m[1];
    const img = a.querySelector('img');
    m = img?.alt?.match(/(\d{2})/);
    return m ? m[1] : null;
  }

  function toPercentCfg(cfg, W, H){
    if (typeof cfg.xPercent === 'number' && typeof cfg.yPercent === 'number') return cfg; // 이미 퍼센트면 그대로
    const dx = +cfg.dx || 0, dy = +cfg.dy || 0;
    const align = String(cfg.align||'TopStart').toLowerCase();
    const basePct = align.includes('center') ? 0.5 : align.includes('end') ? 1 : 0; // Start=0, Center=0.5, End=1
    const aspect = (W / H) || 1;

    // 원래 렌더: top = dy * (H/BASE_H), left = base + dx * (H/BASE_H)
    // 퍼센트 변환: y% = top/H = dy/BASE_H,  x% = left/W = basePct + dx/(BASE_H * (W/H))
    const yPct = dy / BASE_H;
    const xPct = basePct + dx / (BASE_H * aspect);

    const out = Object.assign({}, cfg, { xPercent: xPct, yPercent: yPct });
    delete out.dx; delete out.dy; // 퍼센트 경로를 강제 사용
    return out;
  }

  function patchLabels(item, labels){
    const num = getPageNumFromItem(item);
    if (!num || !TARGETS.has(num)) return labels; // 03~06 외에는 그대로
    const rect = item.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    return (labels || []).map(cfg => (('dx' in cfg || 'dy' in cfg) ? toPercentCfg(cfg, W, H) : cfg));
  }

  function install(){
    if (typeof window.layoutLabels !== 'function') return false;
    if (window.__labelsPatched) return true;
    const orig = window.layoutLabels;
    window.layoutLabels = function(item, labels){
      const patched = patchLabels(item, labels);
      return orig.call(this, item, patched);
    };
    window.__labelsPatched = true;
    return true;
  }

  if (!install()){
    document.addEventListener('DOMContentLoaded', install, { once: true });
    setTimeout(install, 500);
  }
})();
</script>
<script>
/* ===== Rescue Overlay Renderer (03–06 dx/dy→% 변환 포함) ===== */
(function(){
  const BASE_H = 600;
  const TARGETS = new Set(["03","04","05","06"]); // 퍼센트 좌표로 강제 변환할 대상
  // JSON 경로: 필요시 v=pc14 등으로 숫자만 바꾸세요.
  const OVERLAYS = [
    "/assets/data/howtouse_overlays_pc.json?v=pc15",
    "/assets/data/howtouse_overlays_pc.json?nocache="+Date.now()
  ];
  const STRINGS = [
    "/assets/data/strings_ko_pc.json?v=pc14",
    "/assets/data/strings_ko_pc.json?nocache="+Date.now()
  ];

  // 컨테이너 탐색(당신의 마크업 모두 지원: id/howtouse-grid/howto-grid)
  function getGrid(){
    return document.getElementById("howtoGrid")
        || document.querySelector(".howtouse-grid")
        || document.querySelector(".howto-grid");
  }

  // 03~06만 크롭 해제(원본 비율 유지) CSS 주입 — 다른 페이지엔 영향 없음
  (function injectCSS(){
    const css = `
      .howtouse-item.ratio-free{ aspect-ratio:unset !important; }
      .howtouse-item.ratio-free img{ height:auto !important; object-fit:contain !important; }
      .overlay{ position:absolute; inset:0; pointer-events:none; }
      .olabel{ position:absolute; color:#000; font-weight:400; }
      .olabel.anchor-topcenter{ transform:translateX(-50%); }
      .olabel.anchor-topend{ transform:translateX(-100%); }
    `;
    const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
  })();

  // JSON 불러오기(여러 후보 URL 중 첫 성공)
  async function loadOne(cands){
    for (const url of cands){
      try{ const r = await fetch(url, {cache:"no-store"}); if (r.ok) return await r.json(); }catch(e){}
    }
    throw new Error("JSON 로드 실패: "+cands[0]);
  }

  function buildMap(pages){
    const map={};
    (pages||[]).forEach(group=>{
      const any = group.find(x=>/^htu(\d{2})_/.test(x.key));
      if (any){ const num = any.key.match(/^htu(\d{2})_/)[1]; map[num]=group; }
    });
    return map;
  }

  function anchorBasePercent(align){
    const a = String(align||'TopStart').toLowerCase();
    if (a.includes('center')) return 0.5;
    if (a.includes('end'))    return 1;
    return 0; // Start
  }

  function toPercentCfg(cfg, W, H){
    if (typeof cfg.xPercent==='number' && typeof cfg.yPercent==='number') return cfg;
    if (!('dx' in cfg || 'dy' in cfg) || !(W>0 && H>0)) return cfg;
    const dx = +cfg.dx||0, dy=+cfg.dy||0;
    const basePct = anchorBasePercent(cfg.align);
    const xPct = basePct + dx/(BASE_H*(W/H));
    const yPct = dy/BASE_H;
    const out = Object.assign({}, cfg, { xPercent:xPct, yPercent:yPct });
    delete out.dx; delete out.dy;
    return out;
  }

  function layoutLabels(card, labels){
    let ol = card.querySelector('.overlay');
    if (!ol){ ol = document.createElement('div'); ol.className='overlay'; card.appendChild(ol); }
    ol.innerHTML='';

    const rect = card.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    const scale = H/BASE_H;

    (labels||[]).forEach(cfg=>{
      const el = document.createElement('div');
      const align = String(cfg.align||'TopStart');
      el.className = 'olabel ' + (
        /Center/i.test(align) ? 'anchor-topcenter' :
        /End/i.test(align)    ? 'anchor-topend'    : 'anchor-topstart'
      );
      // 텍스트
      const key = cfg.key;
      el.textContent = (window.__STRINGS && window.__STRINGS[key]) || key;
      // 스타일
      if (cfg.bold) el.style.fontWeight='700';
      if (cfg.sizeSp) el.style.fontSize = cfg.sizeSp+'px';
      if (cfg.lineHeightSp) el.style.lineHeight = cfg.lineHeightSp+'px';
      if (cfg.textAlign){
        el.style.textAlign = {Center:'center',End:'right',Start:'left'}[cfg.textAlign] || 'left';
      }
      if (cfg.maxWidthPercent) el.style.maxWidth = (cfg.maxWidthPercent*W)+'px';
      // 위치
      if (typeof cfg.xPercent==='number' && typeof cfg.yPercent==='number'){
        el.style.left = (cfg.xPercent*100)+'%';
        el.style.top  = (cfg.yPercent*100)+'%';
      } else {
        const dx=(+cfg.dx||0)*scale, dy=(+cfg.dy||0)*scale;
        const aLow = align.toLowerCase();
        const base = aLow.includes('center') ? W/2 : aLow.includes('end') ? W : 0;
        el.style.left = (base + dx) + 'px';
        el.style.top  = dy + 'px';
      }
      ol.appendChild(el);
    });
  }

  async function run(){
    const grid = getGrid();
    if (!grid){ console.error('[rescue] grid not found'); return; }

    // 데이터 로드
    const [ov, ko] = await Promise.all([
      loadOne(OVERLAYS),
      loadOne(STRINGS).catch(()=>({}))  // strings는 없어도 진행
    ]);
    window.__STRINGS = ko||{};
    const map = buildMap(ov.pages);

    // 22개 카드 모두 처리
    const cards = grid.querySelectorAll('.howtouse-item, .howto-item');
    cards.forEach(card=>{
      // 페이지 번호 추출
      let href = card.getAttribute('href') || '';
      const m = href.match(/howtouse(\d{2})\./);
      if (!m){
        const img = card.querySelector('img');
        const m2 = img?.alt?.match(/(\d{2})/);
        if (!m2) return;
        href = `howtouse${m2[1]}.jpg`;
      }
      const num = (href.match(/howtouse(\d{2})\./)||[])[1];
      if (!num) return;

      // 03~06 크롭 해제(원본 비율 유지)
      if (TARGETS.has(num)) card.classList.add('ratio-free');

      const labels = map[num];
      if (!labels){
        // 경고 배지
        let ol = card.querySelector('.overlay');
        if (!ol){ ol=document.createElement('div'); ol.className='overlay'; card.appendChild(ol); }
        const warn = document.createElement('div');
        warn.className='olabel anchor-topcenter';
        warn.style.cssText='left:50%;top:10px;font-size:14px;color:#d00';
        warn.textContent = `⚠ 오버레이 없음 (htu${num}_*)`;
        ol.appendChild(warn);
        return;
      }

      // 03~06만 dx/dy → 퍼센트 변환
      const rect = card.getBoundingClientRect();
      const W = rect.width, H = rect.height;
      const patched = TARGETS.has(num)
        ? labels.map(cfg => toPercentCfg(cfg, W, H))
        : labels;

      layoutLabels(card, patched);

      // 리사이즈/이미지 로드에 반응해 재배치
      new ResizeObserver(()=> layoutLabels(card, patched)).observe(card);
    });
  }

  window.addEventListener('load', ()=>run().catch(e=>console.error('[rescue] failed', e)));
})();
</script>

</body>
</html>
