<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — 사용법</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="preload" as="image" href="/images/mm_logo_small.jpg" />
  <style>
    :root { --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --pri:#5eead4; --border:#1e2230; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#e7edf5}
    a{color:var(--pri);text-decoration:none} a:hover{text-decoration:underline}
    header,main,footer{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-img{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1422}
    nav a{margin-left:16px;color:#cfd6e4}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:8px 0 2px;font-size:22px}
    p.muted{color:var(--muted);margin:2px 0 0}
    .howtouse{ margin-top:10px; }

/* 그리드 기본(데스크톱 3열, 태블릿 2열) */
.howtouse-grid{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
@media (max-width:1024px){
  .howtouse-grid{ grid-template-columns: repeat(2, 1fr); }
}

/* ✅ 데스크톱/태블릿: 카드 높이 고정(행 균일) */
@media (min-width:641px){
  .howtouse-item{ 
    display:block;            /* 안전 */
    aspect-ratio: 1 / 2;      /* 필요하면 3/4, 4/5 등으로 조절 가능 */
    position: relative;
    overflow: hidden;
  }
  .howtouse-item img{
    width:100%;
    height:100%;              /* 카드 높이에 맞춤 */
    object-fit: cover;        /* 크롭해서 균일 높이 유지 */
    display:block;
  }
}

/* 📱 모바일: 1열, 원본 비율 */
@media (max-width:640px){
  .howtouse-grid{ grid-template-columns: 1fr; }
  .howtouse-item{ aspect-ratio: auto; }
  .howtouse-item img{ height:auto; object-fit: contain; }
}
    .howtouse-item{ position:relative; display:block; border-radius:10px; overflow:hidden; background:#0f1320; aspect-ratio:1/2; border:1px solid var(--border); }
    .howtouse-item img{ width:100%; height:100%; object-fit:cover; display:block; image-rendering:auto; transition:transform .2s ease-out, opacity .2s ease-out; opacity:.98; }
    .howtouse-item:hover img{ transform:scale(1.02); opacity:1; }
    .overlay{ position:absolute; inset:0; pointer-events:none; }
    .olabel{ position:absolute; white-space:pre-wrap; color:#000; text-shadow:none; filter:none; }
    .anchor-topstart{ transform: translate(0,0); }
    .anchor-topcenter{ transform: translate(-50%,0); left:50%; }
    .anchor-topend{ transform: translate(-100%,0); }
    .debug .olabel { outline:1px dashed rgba(0,0,0,.35); }
    footer{margin:30px auto 60px;text-align:center;color:var(--muted);font-size:14px}
    /* JS 작동 확인용 토스트 */
    #ping{position:fixed;top:8px;right:8px;background:#16a34a;color:#fff;padding:6px 10px;border-radius:8px;z-index:99999;font:12px/1 system-ui}
    /* 03~06만 원본 비율 유지(크롭 금지) */
  .howtouse-item.ratio-free{ aspect-ratio: unset !important; }
  .howtouse-item.ratio-free img{
    height: auto !important;
    object-fit: contain !important; /* cover → contain */
  }
/* === 미리보기/모드 전환 툴바 === */
.howto-toolbar{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  margin:10px 0 12px; font-size:14px;
}
.howto-toolbar .mini{
  padding:6px 10px; border-radius:8px; border:1px solid #1e2230;
  background:#121622; color:#e7edf5; cursor:pointer;
}
.howto-toolbar label{display:flex; gap:6px; align-items:center}
.howto-toolbar input[type="number"], .howto-toolbar select{
  padding:6px 8px; border-radius:8px; border:1px solid #1e2230; background:#0f1320; color:#e7edf5;
}

/* === 라벨 에디터 패널 === */
#editorPanel{
  margin:8px 0 0; padding:12px; border:1px dashed #2a3042; border-radius:12px;
  background:#0f1320; display:none;
}
#editorPanel table{width:100%; border-collapse:collapse; font-size:13px}
#editorPanel th, #editorPanel td{border-bottom:1px solid #1e2230; padding:6px 8px; vertical-align:top}
#editorPanel input[type="text"], #editorPanel input[type="number"], #editorPanel select{
  width:100%; padding:6px 8px; border:1px solid #2a3042; border-radius:8px; background:#0b0f1c; color:#e7edf5;
}
#editorPanel .row-actions{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px}
#editorPanel .mini{padding:6px 10px; border-radius:8px; border:1px solid #2a3042; background:#121622; color:#e7edf5; cursor:pointer}
#exportArea{width:100%; min-height:120px; margin-top:8px; padding:8px; background:#0b0f1c; color:#cfe3ff; border:1px solid #2a3042; border-radius:8px}

</style>

<style id="__howto_grid_lock">
/* 데스크톱/태블릿: 3열/2열, 행 순서 고정 */
@media (min-width:1025px){
  #howtoGrid.howtouse-grid{ display:grid !important; grid-template-columns:repeat(3,1fr) !important; gap:12px !important; }
}
@media (min-width:641px) and (max-width:1024px){
  #howtoGrid.howtouse-grid{ display:grid !important; grid-template-columns:repeat(2,1fr) !important; gap:12px !important; }
}
/* 카드 높이/이미지: PC는 예전처럼 고정 비율 + cover */
@media (min-width:641px){
  #howtoGrid .howtouse-item{ aspect-ratio:1/2 !important; position:relative; overflow:hidden; }
  #howtoGrid .howtouse-item img{ width:100%; height:100% !important; object-fit:cover !important; display:block; }
}
/* 모바일: 1열(기존 의도) */
@media (max-width:640px){
  #howtoGrid.howtouse-grid{ display:grid !important; grid-template-columns:1fr !important; gap:12px !important; }
  #howtoGrid .howtouse-item{ aspect-ratio:auto !important; }
  #howtoGrid .howtouse-item img{ height:auto !important; object-fit:contain !important; }
}
</style>


</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo_small.jpg" alt="Measure Master" class="logo-img" width="28" height="28"
         loading="eager" fetchpriority="high"
         onerror="this.onerror=null; this.src='/images/mm_logo_small.png';" />
    <strong>Measure Master</strong>
  </div>
  <nav>
    <a href="/">홈</a>
    <a href="/howtouse.html">사용법</a>
    <a href="/reviews.html">사용후기</a>
    <a href="/privacy.html">개인정보처리방침</a>
  </nav>
</header>

<main>
  <section class="card howtouse">
    <h1>사용법</h1>
    <p class="muted">총 22장 · 이미지를 탭하면 원본이 새 탭에서 열립니다.</p>
    <div class="howto-toolbar">
      <label>모드
        <select id="modeSel">
          <option value="pc">PC</option>
          <option value="mo">모바일</option>
       </select>
     </label>
     <label>페이지
       <input id="pageSel" type="number" min="1" max="23" value="1">
     </label>
     <button id="btnPreview" class="mini" type="button">미리보기 켜기</button>
     <button id="btnEditor" class="mini" type="button">에디터 열기</button>
   </div>
   <div id="editorPanel"></div>
   <div id="howtoGrid" class="howtouse-grid"></div>
 </section>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<script>
/* howtouse 렌더러 v2: 라이트박스(오버레이 포함) + PC에서 모바일 CSS 에뮬레이션 + map스코프/강제모드 버그 수정 */
(function () {
  /* ====== 설정 ====== */
  const GRID_ID      = "howtoGrid";
  const TOTAL_PAGES  = 23;
  const IMG_DIRS     = ["/images/howtouse", "/image/howtouse"];
  const IMG_PREFIX   = "howtouse";
  const IMG_EXTS     = ["jpg","png","jpeg","webp"];
  const STRINGS_JSON = "/assets/data/strings_ko_pc.json?v=pc28";
  const BASE_H       = 600; // 오버레이 높이 기준(상대 배치용)

  function pickOverlayJson() {
    const qs = new URLSearchParams(location.search);
    const force = (qs.get("ovr") || qs.get("mode") || "").toLowerCase();
    const base = "/assets/data";
    if (force === "mo") return `${base}/howtouse_overlays_mo.json?v=mo1`;
    if (force === "pc") return `${base}/howtouse_overlays_pc.json?v=pc28`;
    const isMo = matchMedia("(max-width: 640px)").matches;
    return isMo ? `${base}/howtouse_overlays_mo.json?v=mo1`
                : `${base}/howtouse_overlays_pc.json?v=pc28`;
  }
  const OVERLAYS_JSON = pickOverlayJson();

  /* ====== 상태(전역) ====== */
  let overlayMap = {};           // 페이지번호 → 라벨 배열
  let stringsDict = {};          // 키 → 텍스트
  const pages = [];              // [{num, url, labels}]
  let lbState = { open:false, idx:0 };

  /* ====== 유틸 ====== */
  const $ = (s, r=document) => r.querySelector(s);
  function grid() {
    return document.getElementById(GRID_ID)
        || document.querySelector(".howtouse-grid")
        || document.querySelector(".howto-grid");
  }
  function createImage(num) {
    const img = new Image();
    img.alt = `사용법 ${num}`;
    img.decoding = "async";
    img.loading = "eager";
    const cands = [];
    for (const d of IMG_DIRS) for (const e of IMG_EXTS) cands.push(`${d}/${IMG_PREFIX}${num}.${e}`);
    let i = 0;
    img.onerror = () => { if (++i < cands.length) img.src = cands[i]; else img.onerror=null; };
    img.src = cands[i];
    return img;
  }
  function parseColorHex(hex){
    if(!hex) return null;
    let s=String(hex).trim();
    if(s.startsWith("0x")) s=s.slice(2);
    if(s.startsWith("#")) s=s.slice(1);
    if(s.length===8){
      const a=parseInt(s.slice(0,2),16)/255, r=parseInt(s.slice(2,4),16),
            g=parseInt(s.slice(4,6),16),    b=parseInt(s.slice(6,8),16);
      return `rgba(${r},${g},${b},${a})`;
    }
    if(s.length===6){
      const r=parseInt(s.slice(0,2),16), g=parseInt(s.slice(2,4),16), b=parseInt(s.slice(4,6),16);
      return `rgb(${r},${g},${b})`;
    }
    return null;
  }
  function anchorClass(align="TopStart"){
    const a=String(align).toLowerCase();
    if(a.includes("center")) return "anchor-topcenter";
    if(a.includes("end"))    return "anchor-topend";
    return "anchor-topstart";
  }

  // 카드/라이트박스 위에 라벨 배치
  function layoutLabels(container, labels, STR){
    let ol = container.querySelector(".overlay");
    if (!ol){ ol = document.createElement("div"); ol.className="overlay"; container.appendChild(ol); }
    ol.innerHTML = "";

    const rect = container.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    const scale = H/BASE_H;

    (labels||[]).forEach(cfg=>{
      const el = document.createElement("div");
      el.className = "olabel " + anchorClass(cfg.align);
      const text = (STR && STR[cfg.key]) || cfg.key || "";
      el.textContent = text;

      if(cfg.bold) el.style.fontWeight = "700";
      if(cfg.sizeSp) el.style.fontSize = cfg.sizeSp + "px";
      if(cfg.lineHeightSp) el.style.lineHeight = cfg.lineHeightSp + "px";
      if(cfg.textAlign) el.style.textAlign = ({Center:"center", End:"right", Start:"left"}[cfg.textAlign]||"left");
      const col = parseColorHex(cfg.colorHex); if (col) el.style.color = col;
      if(cfg.maxWidthPercent) el.style.maxWidth = (cfg.maxWidthPercent*W) + "px";

      if(typeof cfg.xPercent==="number" && typeof cfg.yPercent==="number"){
        el.style.left = (cfg.xPercent*100) + "%";
        el.style.top  = (cfg.yPercent*100) + "%";
      }else{
        const a = String(cfg.align||"").toLowerCase();
        const base = a.includes("center") ? W/2 : a.includes("end") ? W : 0;
        el.style.left = (base + (cfg.dx||0)*scale) + "px";
        el.style.top  = ((cfg.dy||0)*scale) + "px";
      }
      ol.appendChild(el);
    });
  }

  // 오버레이 페이지 매핑 생성
  function buildMap(pages){
    const map = {};
    let premCandidate = null;
    (pages||[]).forEach(group=>{
      const any = group.find(it=>it && typeof it.key === 'string');
      const key = any ? any.key : '';
      let m = key.match(/htu(\d{2})_/i);
      if (m){ map[m[1]] = group; return; }
      const anyWithDigits = group.find(it=>/\d{2}/.test(it.key||''));
      if (anyWithDigits){
        const m2 = (anyWithDigits.key||'').match(/(\d{2})/);
        if (m2){ map[m2[1]] = group; return; }
      }
      if (!premCandidate && group.some(it=>/^prem1_/i.test(it.key||''))){
        premCandidate = group;
      }
    });
    if (!map["23"] && premCandidate) map["23"] = premCandidate;
    return map;
  }

  async function loadJson(url){
    try{
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }catch(e){
      console.warn("[howtouse] JSON load 실패:", url, e.message);
      return null;
    }
  }

  /* ====== 라이트박스 ====== */
  function ensureLightbox(){
    if (document.getElementById("htuLb")) return document.getElementById("htuLb");
    const lb = document.createElement("div");
    lb.id = "htuLb";
    lb.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:9999";
    lb.innerHTML = `
      <div id="htuLbCard" style="position:relative;max-width:92vw;max-height:88vh">
        <img id="htuLbImg" alt="" style="display:block;max-width:92vw;max-height:88vh;border-radius:12px"/>
        <div class="overlay"></div>
        <button id="htuLbClose" aria-label="닫기" style="position:absolute;top:-10px;right:-10px;width:42px;height:42px;border:none;border-radius:999px;background:#111;color:#fff;cursor:pointer;font-size:22px;line-height:1">×</button>
        <button id="htuLbPrev"  aria-label="이전" style="position:absolute;left:-52px;top:50%;transform:translateY(-50%);width:38px;height:38px;border:none;border-radius:999px;background:#111;color:#fff;cursor:pointer;font-size:20px">‹</button>
        <button id="htuLbNext"  aria-label="다음" style="position:absolute;right:-52px;top:50%;transform:translateY(-50%);width:38px;height:38px;border:none;border-radius:999px;background:#111;color:#fff;cursor:pointer;font-size:20px">›</button>
      </div>
    `;
    document.body.appendChild(lb);

    lb.addEventListener("click", (e)=>{ if(e.target === lb) closeLb(); });
    $("#htuLbClose", lb).addEventListener("click", closeLb);
    $("#htuLbPrev", lb).addEventListener("click", ()=> navLb(-1));
    $("#htuLbNext", lb).addEventListener("click", ()=> navLb(+1));
    document.addEventListener("keydown", (e)=>{
      if(!lbState.open) return;
      if(e.key === "Escape") closeLb();
      if(e.key === "ArrowLeft") navLb(-1);
      if(e.key === "ArrowRight") navLb(+1);
    });
    return lb;
  }
  function openLb(idx){
    lbState.open = true; lbState.idx = idx;
    const lb = ensureLightbox();
    lb.style.display = "flex";
    renderLb();
    document.body.style.overflow = "hidden";
  }
  function closeLb(){
    lbState.open = false;
    const lb = ensureLightbox();
    lb.style.display = "none";
    document.body.style.overflow = "";
  }
  function navLb(delta){
    if (!pages.length) return;
    lbState.idx = (lbState.idx + delta + pages.length) % pages.length;
    renderLb();
  }
  function renderLb(){
    const lb = ensureLightbox();
    const img = $("#htuLbImg", lb);
    const card = $("#htuLbCard", lb);
    const item = pages[lbState.idx];
    if (!item) return;
    img.onload = ()=> layoutLabels(card, item.labels, stringsDict);
    img.src = item.url;
    // 첫 그리드 렌더보다 라이트박스가 더 넓으면 라벨 재배치
    setTimeout(()=> layoutLabels(card, item.labels, stringsDict), 30);
  }

  /* ====== 미리보기 툴바 ====== */
  function injectPreviewToolbar(container){
    const qs = new URLSearchParams(location.search);
    const pv = (qs.get("preview") || qs.get("pv") || "").toLowerCase();
    const enabled = pv === "1" || pv === "on" || pv === "true";
    if (!enabled) return;

    const bar = document.createElement("div");
    bar.style.cssText = "position:sticky;top:8px;z-index:10;margin:8px 0 12px;padding:8px;border:1px solid #1e2230;border-radius:10px;background:#0f1320;color:#cfd6e4;display:flex;flex-wrap:wrap;align-items:center;gap:12px";
    bar.innerHTML = `
      <strong style="font-size:12px">미리보기</strong>
      <label style="display:inline-flex;align-items:center;gap:6px">
        폭 <input id="pv-width" type="range" min="280" max="1100" step="10" value="${Math.min(container.clientWidth||720,1100)}">
      </label>
      <span id="pv-width-val" style="font-size:12px"></span>
      <label style="display:inline-flex;align-items:center;gap:6px;margin-left:8px">
        <input id="pv-mo" type="checkbox"> 모바일 CSS 에뮬레이션
      </label>
    `;
    container.parentNode.insertBefore(bar, container);

    const rng = $("#pv-width", bar);
    const out = $("#pv-width-val", bar);
    const cb  = $("#pv-mo", bar);

    // width 적용
    const applyWidth = ()=>{
      const px = Number(rng.value||720);
      out.textContent = px + "px";
      container.style.maxWidth = px + "px";
      container.style.marginLeft = "auto";
      container.style.marginRight = "auto";
      window.dispatchEvent(new Event("resize"));
    };
    rng.addEventListener("input", applyWidth);
    applyWidth();

    // 모바일 CSS 에뮬레이션: grid 1열 + 이미지 contain + aspect-ratio:auto
    const applyMo = (on)=>{
      const items = container.querySelectorAll(".howtouse-item");
      const imgs  = container.querySelectorAll(".howtouse-item img");

      if (on){
        // grid 1열
        container.style.setProperty("display","grid","important");
        container.style.setProperty("grid-template-columns","1fr","important");
        container.style.setProperty("gap","12px","important");
        // 카드/이미지
        items.forEach(el=>{
          el.style.setProperty("aspect-ratio","auto","important");
          el.style.setProperty("position","relative","important");
          el.style.setProperty("overflow","hidden","important");
        });
        imgs.forEach(el=>{
          el.style.setProperty("height","auto","important");
          el.style.setProperty("object-fit","contain","important");
          el.style.setProperty("width","100%","important");
          el.style.setProperty("display","block","important");
        });
      }else{
        // 리셋(초기 스타일로 복귀)
        container.style.removeProperty("display");
        container.style.removeProperty("grid-template-columns");
        container.style.removeProperty("gap");
        items.forEach(el=>{
          el.style.removeProperty("aspect-ratio");
          el.style.removeProperty("position");
          el.style.removeProperty("overflow");
        });
        imgs.forEach(el=>{
          el.style.removeProperty("height");
          el.style.removeProperty("object-fit");
          el.style.removeProperty("width");
          el.style.removeProperty("display");
        });
      }
      // 레이아웃 변화에 따라 라벨 재배치
      setTimeout(()=> window.dispatchEvent(new Event("resize")), 30);
    };
    cb.addEventListener("change", ()=> applyMo(cb.checked));
  }

  /* ====== 메인 렌더 ====== */
  async function init(){
    const container = grid();
    if (!container){ console.error("[howtouse] grid container not found"); return; }
    container.innerHTML = "";

    let overlays = null;
    [overlays, stringsDict] = await Promise.all([
      loadJson(OVERLAYS_JSON),
      loadJson(STRINGS_JSON),
    ]);
    overlayMap = overlays?.pages ? buildMap(overlays.pages) : {};

    for (let i=1; i<=TOTAL_PAGES; i++){
      const num = String(i).padStart(2,"0");
      const url = `${IMG_DIRS[0]}/${IMG_PREFIX}${num}.jpg`;

      const a = document.createElement("a");
      a.className = "howtouse-item";
      a.target = "_blank";
      a.rel = "noopener";
      a.href = url; // 수정/검토용: Ctrl/Shift+클릭은 원본 새탭
      const img = createImage(num);
      a.appendChild(img);

      const ol = document.createElement("div");
      ol.className = "overlay"; a.appendChild(ol);
      container.appendChild(a);

      const labels = overlayMap[num] || null;
      if (labels){
        const render = () => layoutLabels(a, labels, stringsDict);
        img.addEventListener("load", render);
        render();
        if ("ResizeObserver" in window) new ResizeObserver(render).observe(a);
        else window.addEventListener("resize", render);
      }

      // 카드 클릭 → 라이트박스(오버레이 포함)
      a.addEventListener("click", (e)=>{
        if (e.ctrlKey || e.metaKey || e.shiftKey) return; // 원본 새탭 허용
        e.preventDefault();
        openLb(i-1);
      });

      pages.push({ num, url, labels: labels||[] });
    }

    injectPreviewToolbar(container);
  }

  /* ====== 최소 오버레이 CSS(없으면만 주입) ====== */
  (function injectCSS(){
    if (document.getElementById("__howtouse_min_css")) return;
    const s = document.createElement("style");
    s.id="__howtouse_min_css";
    s.textContent = `
      .overlay{position:absolute;i


<style>
/* ====== 에디터용 스타일 ====== */
#howtoEditorBar{
  position:fixed; right:12px; bottom:12px;
  background:#111827; color:#e5e7eb;
  border:1px solid #374151; border-radius:12px;
  padding:8px 10px; z-index:99999;
  display:flex; align-items:center; gap:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.25);
}
#howtoEditorBar button{ background:#2563eb; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }
#howtoEditorBar select{ background:#0f172a; color:#e5e7eb; border:1px solid #374151; border-radius:6px; padding:4px 6px; }
#howtoEditorBar .ht-import{ background:#0f172a; border:1px dashed #475569; color:#e5e7eb; border-radius:8px; padding:4px 8px; cursor:pointer; }

.overlay.editing{ pointer-events:auto; }
.overlay.editing .olabel{ pointer-events:auto; outline:1px dashed rgba(37,99,235,.45); }
.olabel.ht-active{ outline:2px solid rgba(37,99,235,.9); }

.olabel .ht-handle{
  position:absolute; width:12px; height:12px;
  border:2px solid #fff; box-shadow:0 1px 2px rgba(0,0,0,.3);
}
.olabel .ht-handle-move{ top:-8px; left:-8px; background:#2563eb; border-radius:999px; cursor:grab; }
.olabel .ht-handle-resize{ right:-8px; bottom:-8px; background:#10b981; border-radius:2px; cursor:se-resize; }
</style>

</body>
</html>
