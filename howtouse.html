<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — 사용법</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="preload" as="image" href="/images/mm_logo_small.jpg" />
  <style>
    :root { --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --pri:#5eead4; --border:#1e2230; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#e7edf5}
    a{color:var(--pri);text-decoration:none} a:hover{text-decoration:underline}
    header,main,footer{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-img{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1422}
    nav a{margin-left:16px;color:#cfd6e4}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:8px 0 2px;font-size:22px}
    p.muted{color:var(--muted);margin:2px 0 0}
    .howtouse{ margin-top:10px; }

/* 그리드 기본(데스크톱 3열, 태블릿 2열) */
.howtouse-grid{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
@media (max-width:1024px){
  .howtouse-grid{ grid-template-columns: repeat(2, 1fr); }
}

/* ✅ 데스크톱/태블릿: 카드 높이 고정(행 균일) */
@media (min-width:641px){
  .howtouse-item{ 
    display:block;            /* 안전 */
    aspect-ratio: 1 / 2;      /* 필요하면 3/4, 4/5 등으로 조절 가능 */
    position: relative;
    overflow: hidden;
  }
  .howtouse-item img{
    width:100%;
    height:100%;              /* 카드 높이에 맞춤 */
    object-fit: cover;        /* 크롭해서 균일 높이 유지 */
    display:block;
  }
}

/* 📱 모바일: 1열, 원본 비율 */
@media (max-width:640px){
  .howtouse-grid{ grid-template-columns: 1fr; }
  .howtouse-item{ aspect-ratio: auto; }
  .howtouse-item img{ height:auto; object-fit: contain; }
}
    .howtouse-item{ position:relative; display:block; border-radius:10px; overflow:hidden; background:#0f1320; aspect-ratio:1/2; border:1px solid var(--border); }
    .howtouse-item img{ width:100%; height:100%; object-fit:cover; display:block; image-rendering:auto; transition:transform .2s ease-out, opacity .2s ease-out; opacity:.98; }
    .howtouse-item:hover img{ transform:scale(1.02); opacity:1; }
    .overlay{ position:absolute; inset:0; pointer-events:none; }
    .olabel{ position:absolute; white-space:pre-wrap; color:#000; text-shadow:none; filter:none; }
    .anchor-topstart{ transform: translate(0,0); }
    .anchor-topcenter{ transform: translate(-50%,0); left:50%; }
    .anchor-topend{ transform: translate(-100%,0); }
    .debug .olabel { outline:1px dashed rgba(0,0,0,.35); }
    footer{margin:30px auto 60px;text-align:center;color:var(--muted);font-size:14px}
    /* JS 작동 확인용 토스트 */
    #ping{position:fixed;top:8px;right:8px;background:#16a34a;color:#fff;padding:6px 10px;border-radius:8px;z-index:99999;font:12px/1 system-ui}
    /* 03~06만 원본 비율 유지(크롭 금지) */
  .howtouse-item.ratio-free{ aspect-ratio: unset !important; }
  .howtouse-item.ratio-free img{
    height: auto !important;
    object-fit: contain !important; /* cover → contain */
  }
/* === 미리보기/모드 전환 툴바 === */
.howto-toolbar{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  margin:10px 0 12px; font-size:14px;
}
.howto-toolbar .mini{
  padding:6px 10px; border-radius:8px; border:1px solid #1e2230;
  background:#121622; color:#e7edf5; cursor:pointer;
}
.howto-toolbar label{display:flex; gap:6px; align-items:center}
.howto-toolbar input[type="number"], .howto-toolbar select{
  padding:6px 8px; border-radius:8px; border:1px solid #1e2230; background:#0f1320; color:#e7edf5;
}

/* === 라벨 에디터 패널 === */
#editorPanel{
  margin:8px 0 0; padding:12px; border:1px dashed #2a3042; border-radius:12px;
  background:#0f1320; display:none;
}
#editorPanel table{width:100%; border-collapse:collapse; font-size:13px}
#editorPanel th, #editorPanel td{border-bottom:1px solid #1e2230; padding:6px 8px; vertical-align:top}
#editorPanel input[type="text"], #editorPanel input[type="number"], #editorPanel select{
  width:100%; padding:6px 8px; border:1px solid #2a3042; border-radius:8px; background:#0b0f1c; color:#e7edf5;
}
#editorPanel .row-actions{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px}
#editorPanel .mini{padding:6px 10px; border-radius:8px; border:1px solid #2a3042; background:#121622; color:#e7edf5; cursor:pointer}
#exportArea{width:100%; min-height:120px; margin-top:8px; padding:8px; background:#0b0f1c; color:#cfe3ff; border:1px solid #2a3042; border-radius:8px}

</style>

<style id="__howto_grid_lock">
/* 데스크톱/태블릿: 3열/2열, 행 순서 고정 */
@media (min-width:1025px){
  #howtoGrid.howtouse-grid{ display:grid !important; grid-template-columns:repeat(3,1fr) !important; gap:12px !important; }
}
@media (min-width:641px) and (max-width:1024px){
  #howtoGrid.howtouse-grid{ display:grid !important; grid-template-columns:repeat(2,1fr) !important; gap:12px !important; }
}
/* 카드 높이/이미지: PC는 예전처럼 고정 비율 + cover */
@media (min-width:641px){
  #howtoGrid .howtouse-item{ aspect-ratio:1/2 !important; position:relative; overflow:hidden; }
  #howtoGrid .howtouse-item img{ width:100%; height:100% !important; object-fit:cover !important; display:block; }
}
/* 모바일: 1열(기존 의도) */
@media (max-width:640px){
  #howtoGrid.howtouse-grid{ display:grid !important; grid-template-columns:1fr !important; gap:12px !important; }
  #howtoGrid .howtouse-item{ aspect-ratio:auto !important; }
  #howtoGrid .howtouse-item img{ height:auto !important; object-fit:contain !important; }
}
</style>
<style id="__howto_hide_public">
  /* 공개 페이지에선 미리보기/툴바류 전부 숨김 */
  .howto-toolbar,
  #howtoToolbar,
  .howtouse-toolbar,
  .preview-controls,
  .preview-toolbar { display:none !important; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo_small.jpg" alt="Measure Master" class="logo-img" width="28" height="28"
         loading="eager" fetchpriority="high"
         onerror="this.onerror=null; this.src='/images/mm_logo_small.png';" />
    <strong>Measure Master</strong>
  </div>
  <nav>
    <a href="/">홈</a>
    <a href="/howtouse.html">사용법</a>
    <a href="/reviews.html">사용후기</a>
    <a href="/privacy.html">개인정보처리방침</a>
  </nav>
</header>

<main>
  <section class="card howtouse">
    <h1>사용법</h1>
    <p class="muted">총 23장 · 이미지를 탭하면 원본이 새 탭에서 열립니다.</p>
    <div class="howto-toolbar">
      <label>모드
        <select id="modeSel">
          <option value="pc">PC</option>
          <option value="mo">모바일</option>
       </select>
     </label>
     <label>페이지
       <input id="pageSel" type="number" min="1" max="23" value="1">
     </label>
     <button id="btnPreview" class="mini" type="button">미리보기 켜기</button>
     <button id="btnEditor" class="mini" type="button">에디터 열기</button>
   </div>
   <div id="editorPanel"></div>
   <div id="howtoGrid" class="howtouse-grid"></div>
 </section>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<script>
/* howtouse 렌더러: 스코프 오류(map 미정의) 해결 + PC/MO 오버레이 자동/강제 선택 + 미리보기 폭조절(옵션)
   사용법:
   - 기본: PC 오버레이 자동 사용(폭은 페이지 CSS에 따름)
   - 모바일 강제:  ?ovr=mo
   - PC 강제:      ?ovr=pc
   - 미리보기 툴바: ?preview=1  (폭 슬라이더로 레이아웃 확인)
*/
(function () {
  /* ====== 설정 ====== */
  const GRID_ID      = "howtoGrid";
  const TOTAL_PAGES  = 23;                    // 이미지 장 수
  const IMG_DIRS     = ["/images/howtouse", "/image/howtouse"]; // 폴더 보조 경로(과거 호환)
  const IMG_PREFIX   = "howtouse";
  const IMG_EXTS     = ["jpg", "png", "jpeg", "webp"];
  const STRINGS_JSON = "/assets/data/strings_ko_pc.json?v=pc28";
  const BASE_H       = 600; // 오버레이 상대배치 기준 높이

  // 쿼리로 오버레이 파일 선택 (없으면 화면폭 기준 자동)
  function pickOverlayJson() {
    const qs = new URLSearchParams(location.search);
    const force = (qs.get("ovr") || qs.get("mode") || "").toLowerCase();
    const base = "/assets/data";
    if (force === "mo") return `${base}/howtouse_overlays_mo.json?v=mo1`;
    if (force === "pc") return `${base}/howtouse_overlays_pc.json?v=pc28`;
    const isMo = window.matchMedia("(max-width: 640px)").matches;
    return isMo
      ? `${base}/howtouse_overlays_mo.json?v=mo1`
      : `${base}/howtouse_overlays_pc.json?v=pc28`;
  }
  const OVERLAYS_JSON = (new URLSearchParams(location.search).get("ovr") === "mo")
  ? "/assets/data/howtouse_overlays_mo.json?v=mo1"
  : "/assets/data/howtouse_overlays_pc.json?v=pc28";


  /* ====== 상태(전역) ====== */
  // ⛔ map is not defined 오류 원인 → 스코프 밖에서 접근.
  // ✅ 파일 스코프 전역으로 선언해 모든 함수에서 접근 가능하게 함.
  let overlayMap = {};
  let labelsMap = {}; // ← 전역에 선언 (map 스코프 오류 방지)

  /* ====== 유틸 ====== */
  function grid() {
    return (
      document.getElementById(GRID_ID) ||
      document.querySelector(".howtouse-grid") ||
      document.querySelector(".howto-grid")
    );
  }

  // 이미지 후보들을 순차 로딩(확장자/경로 폴백)
  function createImage(num) {
    const img = new Image();
    img.alt = `사용법 ${num}`;
    img.decoding = "async";
    img.loading = "eager";
    const cands = [];
    for (const d of IMG_DIRS) {
      for (const e of IMG_EXTS) {
        cands.push(`${d}/${IMG_PREFIX}${num}.${e}`);
      }
    }
    let i = 0;
    img.onerror = () => {
      i++;
      if (i < cands.length) img.src = cands[i];
      else img.onerror = null;
    };
    img.src = cands[i];
    return img;
  }

  function parseColorHex(hex) {
    if (!hex) return null;
    let s = String(hex).trim();
    if (s.startsWith("0x")) s = s.slice(2);
    if (s.startsWith("#")) s = s.slice(1);
    if (s.length === 8) {
      const a = parseInt(s.slice(0, 2), 16) / 255;
      const r = parseInt(s.slice(2, 4), 16);
      const g = parseInt(s.slice(4, 6), 16);
      const b = parseInt(s.slice(6, 8), 16);
      return `rgba(${r},${g},${b},${a})`;
    }
    if (s.length === 6) {
      const r = parseInt(s.slice(0, 2), 16);
      const g = parseInt(s.slice(2, 4), 16);
      const b = parseInt(s.slice(4, 6), 16);
      return `rgb(${r},${g},${b})`;
    }
    return null;
  }

  function anchorClass(align = "TopStart") {
    const a = String(align).toLowerCase();
    if (a.includes("center")) return "anchor-topcenter";
    if (a.includes("end")) return "anchor-topend";
    return "anchor-topstart";
  }

  // 카드 위에 라벨을 그려주는 함수(오버레이 JSON 호환)
  function layoutLabels(card, labels, STR) {
    let ol = card.querySelector(".overlay");
    if (!ol) {
      ol = document.createElement("div");
      ol.className = "overlay";
      card.appendChild(ol);
    }
    ol.innerHTML = "";

    const rect = card.getBoundingClientRect();
    const W = rect.width;
    const H = rect.height;
    const scale = H / BASE_H;

    (labels || []).forEach((cfg) => {
      const el = document.createElement("div");
      el.className = "olabel " + anchorClass(cfg.align);
      const text = (STR && STR[cfg.key]) || cfg.key || "";
      el.textContent = text;

      if (cfg.bold) el.style.fontWeight = "700";
      if (cfg.sizeSp) el.style.fontSize = cfg.sizeSp + "px";
      if (cfg.lineHeightSp) el.style.lineHeight = cfg.lineHeightSp + "px";
      if (cfg.textAlign)
        el.style.textAlign =
          { Center: "center", End: "right", Start: "left" }[cfg.textAlign] ||
          "left";
      const col = parseColorHex(cfg.colorHex);
      if (col) el.style.color = col;
      if (cfg.maxWidthPercent)
        el.style.maxWidth = cfg.maxWidthPercent * W + "px";

      if (
        typeof cfg.xPercent === "number" &&
        typeof cfg.yPercent === "number"
      ) {
        el.style.left = cfg.xPercent * 100 + "%";
        el.style.top = cfg.yPercent * 100 + "%";
      } else {
        const a = String(cfg.align || "").toLowerCase();
        const baseX = a.includes("center") ? W / 2 : a.includes("end") ? W : 0;
        const dx = (cfg.dx || 0) * scale;
        const dy = (cfg.dy || 0) * scale;
        el.style.left = baseX + dx + "px";
        el.style.top = dy + "px";
      }
      ol.appendChild(el);
    });
  }

  // 오버레이 페이지 매핑:
  // 1) 키가 htuNN_* 이면 NN 매핑
  // 2) 키에 2자리 숫자 있으면 그 숫자를 페이지로
  // 3) prem1_* 그룹은 23으로 매핑(없을 때만)
  function buildMap(pages) {
    const mapObj = {};
    let premCandidate = null;

    (pages || []).forEach((group) => {
      const any = group.find((it) => it && typeof it.key === "string");
      const key = any ? any.key : "";

      let m = key.match(/htu(\d{2})_/i);
      if (m) {
        mapObj[m[1]] = group;
        return;
      }

      const anyWithDigits = group.find((it) => /\d{2}/.test(it.key || ""));
      if (anyWithDigits) {
        const m2 = (anyWithDigits.key || "").match(/(\d{2})/);
        if (m2) {
          mapObj[m2[1]] = group;
          return;
        }
      }

      if (!premCandidate && group.some((it) => /^prem1_/i.test(it.key || ""))) {
        premCandidate = group;
      }
    });

    if (!mapObj["23"] && premCandidate) mapObj["23"] = premCandidate;
    return mapObj;
  }

  async function loadJson(url) {
    try {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    } catch (e) {
      console.warn("[howtouse] JSON load 실패:", url, e.message);
      return null;
    }
  }

  /* ====== 메인 렌더 ====== */
  async function init() {
    const qs = new URLSearchParams(location.search);
    const w = parseInt(qs.get("w"), 10);
    if (w && w >= 280 && w <= 1400) {
     const el = document.getElementById("howtoGrid") || document.querySelector(".howtouse-grid");
     if (el) { el.style.maxWidth = w + "px"; el.style.margin = "0 auto"; }
    }

    const container = grid();
    if (!container) {
      console.error("[howtouse] grid container not found");
      return;
    }
    container.innerHTML = "";

    let overlays = null,
      strings = null;
    [overlays, strings] = await Promise.all([
      loadJson(OVERLAYS_JSON),
      loadJson(STRINGS_JSON),
    ]);
    overlayMap =
      overlays && Array.isArray(overlays.pages)
        ? buildMap(overlays.pages)
        : {};
    console.log("[howtouse] overlayMap keys:", Object.keys(overlayMap));

    // 렌더 순서를 재정렬: 1..19, 23, 20, 21, 22
    const renderOrder = (function(){
      const arr = [];
      for (let n = 1; n <= TOTAL_PAGES; n++) arr.push(n);
      // 23을 빼고
      const idx23 = arr.indexOf(23);
      if (idx23 !== -1) arr.splice(idx23, 1);
      // 19 다음(= 19의 다음 인덱스)에 23을 꽂는다
      const idx19 = arr.indexOf(19);
      arr.splice(idx19 + 1, 0, 23);
      return arr;
    })();


    for (const i of renderOrder) {
      const num = String(i).padStart(2, "0");

      // 카드
      const a = document.createElement("a");
      a.className = "howtouse-item";
      a.target = "_blank";
      a.rel = "noopener";
      a.href = `${IMG_DIRS[0]}/${IMG_PREFIX}${num}.jpg`;

      const img = createImage(num);
      a.appendChild(img);

      const ol = document.createElement("div");
      ol.className = "overlay";
      a.appendChild(ol);

      container.appendChild(a);

      // 오버레이
      const labels = overlayMap[num];
      if (labels) {
        const STR = strings || {};
        const render = () => layoutLabels(a, labels, STR);
        img.addEventListener("load", render);
        render();
        if ("ResizeObserver" in window) {
          new ResizeObserver(render).observe(a);
        } else {
          window.addEventListener("resize", render);
        }
      }
    }

    injectPreviewToolbar(container); // 옵션: ?preview=1
  }

  /* ====== 미리보기 툴바(옵션: ?preview=1) ====== */
  function injectPreviewToolbar(container) {
    const qs = new URLSearchParams(location.search);
    const pv = (qs.get("preview") || qs.get("pv") || "").toLowerCase();
    const enabled = pv === "1" || pv === "on" || pv === "true";
    if (!enabled) return;

    const bar = document.createElement("div");
    bar.style.cssText =
      "position:sticky;top:8px;z-index:10;margin:8px 0 12px;padding:8px;border:1px solid #1e2230;border-radius:10px;background:#0f1320;color:#cfd6e4;display:flex;flex-wrap:wrap;align-items:center;gap:10px";
    bar.innerHTML = `
      <strong style="font-size:12px">미리보기</strong>
      <label style="display:inline-flex;align-items:center;gap:6px">
        폭 <input id="pv-width" type="range" min="280" max="1100" step="10" value="${Math.min(container.clientWidth || 720, 1100)}">
      </label>
      <span id="pv-width-val" style="font-size:12px"></span>
    `;
    container.parentNode.insertBefore(bar, container);

    const rng = bar.querySelector("#pv-width");
    const out = bar.querySelector("#pv-width-val");

    const apply = () => {
      const px = Number(rng.value || 720);
      out.textContent = px + "px";
      container.style.maxWidth = px + "px";
      container.style.marginLeft = "auto";
      container.style.marginRight = "auto";
      window.dispatchEvent(new Event("resize")); // 오버레이 재배치
    };
    rng.addEventListener("input", apply);
    apply();
  }

  /* ====== 최소 오버레이 CSS 주입(없을 때만) ====== */
  (function injectCSS() {
    if (document.getElementById("__howtouse_min_css")) return;
    const s = document.createElement("style");
    s.id = "__howtouse_min_css";
    s.textContent = `
      .overlay{position:absolute;inset:0;pointer-events:none}
      .olabel{position:absolute;color:#000;font-weight:400}
      .olabel.anchor-topcenter{transform:translateX(-50%)}
      .olabel.anchor-topend{transform:translateX(-100%)}
      .howtouse-item{position:relative}
    `;
    document.head.appendChild(s);
  })();

  // 시작
  window.addEventListener("load", init);
})();
</script>
<style>
/* ====== 에디터용 스타일 ====== */
#howtoEditorBar{
  position:fixed; right:12px; bottom:12px;
  background:#111827; color:#e5e7eb;
  border:1px solid #374151; border-radius:12px;
  padding:8px 10px; z-index:99999;
  display:flex; align-items:center; gap:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.25);
}
#howtoEditorBar button{ background:#2563eb; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }
#howtoEditorBar select{ background:#0f172a; color:#e5e7eb; border:1px solid #374151; border-radius:6px; padding:4px 6px; }
#howtoEditorBar .ht-import{ background:#0f172a; border:1px dashed #475569; color:#e5e7eb; border-radius:8px; padding:4px 8px; cursor:pointer; }

.overlay.editing{ pointer-events:auto; }
.overlay.editing .olabel{ pointer-events:auto; outline:1px dashed rgba(37,99,235,.45); }
.olabel.ht-active{ outline:2px solid rgba(37,99,235,.9); }

.olabel .ht-handle{
  position:absolute; width:12px; height:12px;
  border:2px solid #fff; box-shadow:0 1px 2px rgba(0,0,0,.3);
}
.olabel .ht-handle-move{ top:-8px; left:-8px; background:#2563eb; border-radius:999px; cursor:grab; }
.olabel .ht-handle-resize{ right:-8px; bottom:-8px; background:#10b981; border-radius:2px; cursor:se-resize; }
</style>
<script>
  // URL에 ?dev=1 이 붙은 경우에만 툴바를 보이도록 허용
  (function () {
    const dev = new URLSearchParams(location.search).get('dev') === '1';
    if (dev) {
      const hider = document.getElementById('__howto_hide_public');
      if (hider) hider.remove(); // 숨김 스타일 제거 → 툴바 표시
    }
  })();
</script>

</body>
</html>
