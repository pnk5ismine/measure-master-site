<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — 사용법</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="preload" as="image" href="/images/mm_logo_small.jpg" />
  <style>
    :root { --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --pri:#5eead4; --border:#1e2230; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#e7edf5}
    a{color:var(--pri);text-decoration:none} a:hover{text-decoration:underline}
    header,main,footer{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-img{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1422}
    nav a{margin-left:16px;color:#cfd6e4}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:8px 0 2px;font-size:22px}
    p.muted{color:var(--muted);margin:2px 0 0}
    .howtouse{ margin-top:10px; }
    .howtouse-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    @media (max-width:1024px){ .howtouse-grid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .howtouse-grid{ grid-template-columns:1fr;} }
    .howtouse-item{ position:relative; display:block; border-radius:10px; overflow:hidden; background:#0f1320; aspect-ratio:1/2; border:1px solid var(--border); }
    .howtouse-item img{ width:100%; height:100%; object-fit:cover; display:block; image-rendering:auto; transition:transform .2s ease-out, opacity .2s ease-out; opacity:.98; }
    .howtouse-item:hover img{ transform:scale(1.02); opacity:1; }
    .overlay{ position:absolute; inset:0; pointer-events:none; }
    .olabel{ position:absolute; white-space:pre-wrap; color:#000; text-shadow:none; filter:none; }
    .anchor-topstart{ transform: translate(0,0); }
    .anchor-topcenter{ transform: translate(-50%,0); left:50%; }
    .anchor-topend{ transform: translate(-100%,0); }
    .debug .olabel { outline:1px dashed rgba(0,0,0,.35); }
    footer{margin:30px auto 60px;text-align:center;color:var(--muted);font-size:14px}
    /* JS 작동 확인용 토스트 */
    #ping{position:fixed;top:8px;right:8px;background:#16a34a;color:#fff;padding:6px 10px;border-radius:8px;z-index:99999;font:12px/1 system-ui}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo_small.jpg" alt="Measure Master" class="logo-img" width="28" height="28"
         loading="eager" fetchpriority="high"
         onerror="this.onerror=null; this.src='/images/mm_logo_small.png';" />
    <strong>Measure Master</strong>
  </div>
  <nav>
    <a href="/">홈</a>
    <a href="/howtouse.html">사용법</a>
    <a href="/reviews.html">사용후기</a>
    <a href="/privacy.html">개인정보처리방침</a>
  </nav>
</header>

<main>
  <section class="card howtouse">
    <h1>사용법</h1>
    <p class="muted">총 22장 · 이미지를 탭하면 원본이 새 탭에서 열립니다.</p>
    <div id="howtoGrid" class="howtouse-grid"></div>
  </section>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<script>
  // ===== 경로(절대경로, 캐시버스터) =====
  const IMG_DIR       = "/images/howtouse";
  const IMG_PREFIX    = "howtouse";
  const IMG_EXTS      = ["jpg","png","jpeg","webp"];
  const TOTAL_PAGES   = 22;
  const OVERLAYS_JSON = "/assets/data/howtouse_overlays_pc.json?v=pc3";
  const STRINGS_KO    = "/assets/data/strings_ko_pc.json?v=pc3";

  // JS 작동 토스트
  document.addEventListener('DOMContentLoaded',()=>{ 
    const ping=document.createElement('div'); ping.id='ping'; ping.textContent='JS OK';
    document.body.appendChild(ping);
    setTimeout(()=> ping.remove(), 2500);
  });

  function showError(msg){
    let bar = document.getElementById("errbar");
    if(!bar){
      bar = document.createElement("div");
      bar.id="errbar";
      bar.style.cssText="position:sticky;top:0;z-index:9999;background:#ff3b30;color:#fff;padding:10px 14px;border-radius:10px;margin:10px 0";
      (document.querySelector("main .card")||document.body).prepend(bar);
    }
    bar.textContent = msg;
    console.error("[howtouse]", msg);
  }

  function parseColorHex(hex){
    if(!hex) return null;
    let s = String(hex).trim();
    if(s.startsWith("0x")) s=s.slice(2);
    if(s.startsWith("#")) s=s.slice(1);
    if(s.length===8){
      const a=parseInt(s.slice(0,2),16)/255, r=parseInt(s.slice(2,4),16), g=parseInt(s.slice(4,6),16), b=parseInt(s.slice(6,8),16);
      return `rgba(${r},${g},${b},${a})`;
    }else if(s.length===6){
      const r=parseInt(s.slice(0,2),16), g=parseInt(s.slice(2,4),16), b=parseInt(s.slice(4,6),16);
      return `rgb(${r},${g},${b})`;
    }
    return null;
  }
  function anchorClass(align="TopStart"){
    const a=String(align||'').toLowerCase();
    if(a.includes("center")) return "anchor-topcenter";
    if(a.includes("end"))    return "anchor-topend";
    return "anchor-topstart";
  }
  async function loadJson(url){
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} @ ${res.url}`);
    try{ return await res.json(); }
    catch(e){ throw new Error(`JSON parse error @ ${url}: ${e.message}`); }
  }
  function createImageWithFallback(num){
    const img = new Image();
    img.alt = `사용법 ${num}`;
    img.loading = "lazy";
    const base = `${IMG_DIR}/${IMG_PREFIX}${num}`;
    let i=0;
    img.onerror = ()=> {
      if(i<IMG_EXTS.length){ img.src = `${base}.${IMG_EXTS[i++]}`; }
      else{
        img.onerror = null;
        img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="1200"><rect width="100%" height="100%" fill="%230f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" opacity="0.4" font-size="20">이미지 없음</text></svg>';
      }
    };
    img.src = `${base}.${IMG_EXTS[i++]}`;
    return img;
  }
  function layoutLabels($item, labels){
    let $overlay = $item.querySelector(".overlay");
    if(!$overlay){ $overlay = document.createElement("div"); $overlay.className="overlay"; $item.appendChild($overlay); }
    if(!labels?.length){ $overlay.innerHTML=""; return; }

    $overlay.innerHTML = "";
    const rect = $item.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    const BASE_H = 600, scale = H/BASE_H;

    labels.forEach(cfg=>{
      const el = document.createElement("div");
      el.className = "olabel " + anchorClass(cfg.align);
      const text = (window.__STRINGS && window.__STRINGS[cfg.key]) || cfg.key;
      el.textContent = text;

      if(cfg.bold) el.style.fontWeight="700";
      if(cfg.sizeSp)       el.style.fontSize   = `${cfg.sizeSp}px`;
      if(cfg.lineHeightSp) el.style.lineHeight = `${cfg.lineHeightSp}px`;
      if(cfg.textAlign)    el.style.textAlign  = ({"Center":"center","End":"right","Start":"left"}[cfg.textAlign] || "left");
      const col = parseColorHex(cfg.colorHex); if(col) el.style.color = col;
      if(cfg.maxWidthPercent) el.style.maxWidth = `${cfg.maxWidthPercent*W}px`;

      if(typeof cfg.xPercent==="number" && typeof cfg.yPercent==="number"){
        el.style.left = `${cfg.xPercent*100}%`;
        el.style.top  = `${cfg.yPercent*100}%`;
      }else{
        const dx=(cfg.dx||0)*scale, dy=(cfg.dy||0)*scale;
        const a=(cfg.align||"").toLowerCase();
        let leftPx = a.includes("center") ? W/2 + dx : a.includes("end") ? W + dx : dx;
        el.style.left = `${leftPx}px`;
        el.style.top  = `${dy}px`;
      }
      $overlay.appendChild(el);
    });
  }
  function buildOverlayMap(pages){
    const map={};
    (pages||[]).forEach(group=>{
      const any = group.find(it=>/^htu(\d{2})_/.test(it.key));
      if(any){ const num = any.key.match(/^htu(\d{2})_/)[1]; map[num]=group; }
    });
    return map;
  }

  (async function init(){
    document.getElementById('year').textContent = new Date().getFullYear();

    // JSON 로드
    let overlaysData=null, stringsKo=null;
    try{ overlaysData = await loadJson(OVERLAYS_JSON); }
    catch(e){ showError(e.message); return; }
    try{ stringsKo = await loadJson(STRINGS_KO); }
    catch(e){ showError(e.message); /* 문자열 실패해도 key로 진행 */ }

    window.__STRINGS = stringsKo || {};
    const map = overlaysData?.pages ? buildOverlayMap(overlaysData.pages) : null;
    if(!map){ showError("오버레이 데이터 형식 오류: pages 배열이 없습니다."); return; }

    const grid = document.getElementById("howtoGrid");
    grid.innerHTML = "";
    for(let i=1;i<=TOTAL_PAGES;i++){
      const num = String(i).padStart(2,"0");
      const a = document.createElement("a");
      a.className = "howtouse-item";
      a.target="_blank"; a.rel="noopener";
      a.href = `${IMG_DIR}/${IMG_PREFIX}${num}.jpg`;

      const img = createImageWithFallback(num);
      a.appendChild(img);
      const ol  = document.createElement("div"); ol.className="overlay"; a.appendChild(ol);
      grid.appendChild(a);

      const labels = map[num];
      if(!labels){
        const warn = document.createElement("div");
        warn.className = "olabel anchor-topcenter";
        warn.style.cssText="left:50%;top:10px;font-size:14px;color:#d00";
        warn.textContent = `⚠ 오버레이 없음 (htu${num}_* 키 확인)`;
        ol.appendChild(warn);
      }else{
        layoutLabels(a, labels);
        new ResizeObserver(()=> layoutLabels(a, labels)).observe(a);
      }
    }
  })();
</script>

<script>
/* ===== Overlay Editor (enable with ?edit=1) ===== */
(function(){
  const params = new URLSearchParams(location.search);
  if (params.get('edit') !== '1') return;

  // 편집 모드용 CSS: 라벨 클릭 허용 + 시각 피드백
  document.body.classList.add('edit-mode');
  const style = document.createElement('style');
  style.textContent = `
    .edit-mode .overlay { pointer-events: auto; }
    .edit-mode .olabel  { cursor: pointer; outline: 1px dashed rgba(0,0,0,.35); }
    .edit-mode .olabel:hover { outline: 2px solid #5eead4; }
  `;
  document.head.appendChild(style);

  // 카드 <a> 클릭 시 원본 이미지로 넘어가지 않도록 차단 (편집 모드 한정)
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('.howtouse-item');
    if (a) { e.preventDefault(); e.stopPropagation(); }
  }, true);

  // 설정(페이지에 쓰신 경로와 동일하게)
  const OVERLAYS_JSON = "/assets/data/howtouse_overlays_pc.json?v=pc3";
  const BASE_H = 600;

  // HUD
  const hud = document.createElement('div');
  hud.style.cssText = "position:fixed;top:8px;right:8px;z-index:99999;background:#0b0d12dd;color:#fff;border:1px solid #1e2230;padding:10px 12px;border-radius:10px;font:12px/1.4 system-ui;max-width:36ch";
  hud.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Overlay Editor</div>
  <div id="ed-info" style="white-space:pre-wrap"></div>
  <div style="margin-top:6px;opacity:.85">
    ↑↓←→: 1px 이동 (Shift=5px)<br/>
    +/-: 글자크기, ;/' : 줄간격, [ ]: 폭%<br/>
    C: JSON 복사
  </div>`;
  document.body.appendChild(hud);
  const info = hud.querySelector('#ed-info');

  // 오버레이 데이터 로드 → 페이지번호별 매핑
  let map = {};
  fetch(OVERLAYS_JSON, {cache:'no-store'}).then(r=>r.json()).then(data=>{
    (data.pages||[]).forEach(group=>{
      const any = group.find(it=>/^htu(\d{2})_/.test(it.key));
      if (any) {
        const num = any.key.match(/^htu(\d{2})_/)[1];
        map[num] = group;
      }
    });
  });

  let selected = null; // {el, cfg, pageNum, card, uses:'percent'|'offset'}

  // 라벨 클릭→선택
  document.addEventListener('click', e=>{
    const label = e.target.closest('.olabel');
    if (!label) return;

    document.querySelectorAll('.olabel').forEach(n=>n.style.outline='1px dashed rgba(0,0,0,.35)');
    label.style.outline = '2px solid #5eead4';

    const card = label.closest('.howtouse-item');
    const a = card?.tagName==='A' ? card : card?.closest('a');
    let pageNum = null;
    if (a?.href) {
      const m = a.href.match(/howtouse(\d{2})\./);
      if (m) pageNum = m[1];
    }
    if (!pageNum) {
      const m2 = card?.querySelector('img')?.alt?.match(/(\d{2})/);
      if (m2) pageNum = m2[1];
    }
    if (!pageNum || !map[pageNum]) { info.textContent = '이 카드의 오버레이 그룹을 찾지 못했습니다.'; return; }

    // 가장 가까운 cfg 선택(현재 화면 좌표 기준)
    const rect = card.getBoundingClientRect();
    const W=rect.width, H=rect.height;
    const left = parseFloat(label.style.left)||0;
    const top  = parseFloat(label.style.top)||0;

    let best=null, bestDist=Infinity;
    for(const cfg of map[pageNum]){
      let cx, cy;
      if (typeof cfg.xPercent==='number' && typeof cfg.yPercent==='number') {
        cx = cfg.xPercent*W; cy = cfg.yPercent*H;
      } else {
        const a = String(cfg.align||'').toLowerCase();
        const base = a.includes('center') ? W/2 : a.includes('end') ? W : 0;
        const scale = H/BASE_H;
        cx = base + (cfg.dx||0)*scale;
        cy = (cfg.dy||0)*scale;
      }
      const d = Math.hypot(left-cx, top-cy);
      if (d<bestDist){ bestDist=d; best=cfg; }
    }

    if (!best){ info.textContent = '라벨 cfg를 찾지 못했습니다.'; return; }

    selected = {
      el: label,
      cfg: best,
      pageNum,
      card,
      uses: (typeof best.xPercent==='number' && typeof best.yPercent==='number') ? 'percent' : 'offset'
    };
    updateHUD();
  }, true);

  function updateHUD(){
    if (!selected){ info.textContent = '라벨을 클릭해서 선택하세요.'; return; }
    const {cfg, pageNum, uses} = selected;
    const snippet = jsonSnippet(cfg, uses);
    info.textContent =
`page: ${pageNum}
key : ${cfg.key}
mode: ${uses==='percent' ? 'xPercent/yPercent' : 'dx/dy'}
size: ${cfg.sizeSp ?? '(default)'}  line: ${cfg.lineHeightSp ?? '(default)'}
maxW: ${cfg.maxWidthPercent ?? '(none)'}  align: ${cfg.align ?? 'TopStart'}

JSON:
${snippet}`;
  }

  function jsonSnippet(cfg, uses){
    const base = {
      key: cfg.key,
      align: cfg.align || 'TopStart',
      sizeSp: cfg.sizeSp,
      lineHeightSp: cfg.lineHeightSp,
      bold: !!cfg.bold,
      textAlign: cfg.textAlign || 'Start',
      maxWidthPercent: cfg.maxWidthPercent
    };
    if (uses==='percent'){
      base.xPercent = +(cfg.xPercent??0).toFixed(4);
      base.yPercent = +(cfg.yPercent??0).toFixed(4);
    } else {
      base.dx = Math.round(cfg.dx||0);
      base.dy = Math.round(cfg.dy||0);
    }
    return JSON.stringify(base, null, 2);
  }

  // 키보드 조정
  document.addEventListener('keydown', (e)=>{
    if (!selected) return;
    const step = e.shiftKey ? 5 : 1;
    const {el, card, cfg, uses} = selected;
    const rect = card.getBoundingClientRect();
    const W=rect.width, H=rect.height, scale=H/BASE_H;

    let dirty=false;

    // 이동
    if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
      e.preventDefault();
      const dxp = e.key==='ArrowLeft'?-step : e.key==='ArrowRight'?step : 0;
      const dyp = e.key==='ArrowUp'  ?-step : e.key==='ArrowDown'?step : 0;
      if (uses==='percent'){
        cfg.xPercent = (cfg.xPercent||0) + dxp/W;
        cfg.yPercent = (cfg.yPercent||0) + dyp/H;
        el.style.left = `${cfg.xPercent*100}%`;
        el.style.top  = `${cfg.yPercent*100}%`;
      } else {
        cfg.dx = Math.round((cfg.dx||0) + dxp/scale);
        cfg.dy = Math.round((cfg.dy||0) + dyp/scale);
        const a = String(cfg.align||'').toLowerCase();
        const base = a.includes('center') ? W/2 : a.includes('end') ? W : 0;
        el.style.left = `${base + (cfg.dx||0)*scale}px`;
        el.style.top  = `${(cfg.dy||0)*scale}px`;
      }
      dirty=true;
    }

    // 글자 크기
    if (e.key==='+' || e.key==='='){ cfg.sizeSp=(cfg.sizeSp||12)+1; el.style.fontSize=`${cfg.sizeSp}px`; dirty=true; }
    if (e.key==='-'){ cfg.sizeSp=(cfg.sizeSp||12)-1; el.style.fontSize=`${cfg.sizeSp}px`; dirty=true; }

    // 줄 간격 ; / '
    if (e.key===';'){ cfg.lineHeightSp=(cfg.lineHeightSp||(cfg.sizeSp||12))-1; el.style.lineHeight=`${cfg.lineHeightSp}px`; dirty=true; }
    if (e.key==="'"){ cfg.lineHeightSp=(cfg.lineHeightSp||(cfg.sizeSp||12))+1; el.style.lineHeight=`${cfg.lineHeightSp}px`; dirty=true; }

    // maxWidthPercent [ / ]
    if (e.key==='['){ cfg.maxWidthPercent=Math.max(0, +(cfg.maxWidthPercent||0)-0.01); el.style.maxWidth=`${cfg.maxWidthPercent*W}px`; dirty=true; }
    if (e.key===']'){ cfg.maxWidthPercent=Math.min(1, +(cfg.maxWidthPercent||0)+0.01); el.style.maxWidth=`${cfg.maxWidthPercent*W}px`; dirty=true; }

    // 복사 C
    if (e.key.toLowerCase()==='c'){
      const js = jsonSnippet(cfg, uses);
      navigator.clipboard.writeText(js).then(()=>{ info.textContent = `✔ JSON 복사됨\n\n${js}`; });
      return;
    }

    if (dirty) updateHUD();
  });

  // 모드 배지
  const tag = document.createElement('div');
  tag.textContent = 'EDIT MODE';
  tag.style.cssText = 'position:fixed;bottom:10px;right:10px;background:#f59e0b;color:#000;padding:4px 8px;border-radius:6px;font:11px/1 system-ui;z-index:99999';
  document.body.appendChild(tag);
})();
</script>

</body>
</html>
