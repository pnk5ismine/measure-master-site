<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Supabase 자가진단 (index2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    input, button { padding: 8px; }
    pre { background:#fafafa; border:1px solid #eee; padding:10px; min-height:140px; }
    .ok { color:#0a7 } .err { color:#c00 }
    .card { border:1px solid #ddd; border-radius:8px; padding:12px; margin:12px 0; }
  </style>
</head>
<body>
  <h1>Supabase 자가진단</h1>
  <p>이 페이지는 <b>테스트 전용</b>입니다. 원본 <code>index.html</code>은 수정하지 마세요.</p>

  <div class="card">
    <strong>세션 상태:</strong>
    <span id="session-text">확인 중…</span>
    <div style="margin-top:8px;">
      <button id="btn-debug-session">세션/유저 보기</button>
      <button id="btn-ensure-profile">프로필 강제 생성</button>
      <button id="btn-logout">로그아웃</button>
    </div>
  </div>

  <div class="card">
    <strong>로그인</strong>
    <div class="row" style="margin-top:8px;">
      <input type="email" id="email" placeholder="이메일" />
      <input type="password" id="password" placeholder="비밀번호" />
    </div>
    <div style="margin-top:8px;">
      <button id="btn-login">로그인</button>
    </div>
    <div id="login-msg" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <strong>로그</strong>
    <pre id="log"></pre>
  </div>

<script type="module">
  const logEl = document.getElementById('log') || (() => {
    const p = document.createElement('pre'); p.id='log'; document.body.appendChild(p); return p
  })()
  const log = (m,e=false)=>{ logEl.textContent=(e?'[ERR] ':'[OK] ')+m+'\n'+logEl.textContent }
  const safe = (fn)=>async(...args)=>{ try{ await fn(...args) }catch(err){ log('예외: '+(err?.message||err), true); console.error(err) } }

  // 환경 진단
  log('proto='+location.protocol+', online='+navigator.onLine)
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    log('⚠️ HTTPS가 아니면 Supabase 호출이 차단될 수 있습니다 (Mixed Content).', true)
  }

  let createClient
  try {
    // CDN 로드 (확장프로그램/네트워크가 막으면 여기서 실패)
    ({ createClient } = await import('https://esm.sh/@supabase/supabase-js@2'))
    log('Supabase SDK import 성공')
  } catch (e) {
    log('Supabase SDK import 실패: '+(e?.message||e), true)
    throw e
  }

  // ⚠️ 여기를 본인 값으로 교체
  const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co'
  const SUPABASE_ANON_KEY = 'YOUR_PUBLIC_ANON_KEY'

  if (!/^https:\/\/.+\.supabase\.co$/.test(SUPABASE_URL)) {
    log('SUPABASE_URL 형식이 이상합니다: '+SUPABASE_URL, true)
  }
  if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.length < 20) {
    log('SUPABASE_ANON_KEY가 비어있거나 짧습니다.', true)
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  log('Supabase 클라이언트 생성됨')

  const $ = (id)=>document.getElementById(id)

  // 세션 표시
  const refreshSession = safe(async()=>{
    const { data, error } = await supabase.auth.getSession()
    if (error) { log('세션 조회 실패: '+error.message, true); return }
    const t = document.getElementById('session-text')
    if (data?.session?.user) {
      t && (t.innerHTML = `<span class="ok">로그인됨</span> (${data.session.user.email})`)
      log('세션 OK: '+data.session.user.email)
    } else {
      t && (t.innerHTML = `<span class="err">로그아웃 상태</span>`)
      log('세션 없음')
    }
  })

  // 프로필 보장
  const ensureProfileExists = safe(async()=>{
    const { data:{ user }, error:uErr } = await supabase.auth.getUser()
    if (uErr) { log('getUser 오류: '+uErr.message, true); return }
    if (!user) { log('로그인 필요(세션 없음)', true); return }
    const { data, error } = await supabase.from('profiles').select('id').eq('id', user.id).maybeSingle()
    if (error) { log('profiles 조회 오류: '+error.message, true); return }
    if (!data) {
      const { error:e2 } = await supabase.from('profiles').upsert({
        id: user.id, email: user.email, last_login: new Date().toISOString()
      }, { onConflict: 'id' })
      if (e2) log('upsert 실패: '+e2.message, true)
      else log('profiles upsert 완료')
    } else {
      log('프로필 이미 존재')
    }
  })

  // 로그인
  const doLogin = safe(async()=>{
    const email = (document.getElementById('email')?.value||'').trim()
    const password = document.getElementById('password')?.value||''
    if (!email || !password) { log('이메일/비밀번호 입력', true); return }
    const { error } = await supabase.auth.signInWithPassword({ email, password })
    if (error) { log('로그인 실패: '+error.message, true) }
    else { log('로그인 성공'); await refreshSession(); await ensureProfileExists() }
  })

  // 바인딩
  document.getElementById('btn-debug-session')?.addEventListener('click', safe(async()=>{
    const s = await supabase.auth.getSession()
    const u = await supabase.auth.getUser()
    log('session.user=' + JSON.stringify(s.data?.session?.user ?? null))
    log('user=' + JSON.stringify(u.data?.user ?? null))
  }))
  document.getElementById('btn-ensure-profile')?.addEventListener('click', ensureProfileExists)
  document.getElementById('btn-logout')?.addEventListener('click', safe(async()=>{
    await supabase.auth.signOut(); await refreshSession(); log('로그아웃 완료')
  }))
  document.getElementById('btn-login')?.addEventListener('click', doLogin)

  // 초기
  log('모듈 스크립트 로드 완료. 버튼을 눌러 테스트하세요.')
  await refreshSession()
</script>

  <!-- 모듈이 전혀 실행되지 않을 때(브라우저/정책 문제) 표시 -->
  <noscript><p class="err">자바스크립트가 비활성화되어 있습니다.</p></noscript>
</body>
</html>
