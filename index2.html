<!-- 세션/유저 디버그 -->
<button id="btn-debug-session">세션/유저 보기</button>
<!-- 프로필 강제 생성(없으면) -->
<button id="btn-ensure-profile">프로필 강제 생성</button>

<script type="module">
  import { supabase } from './supabaseClient.js'

  const debugLog = document.getElementById('debug-log') || document.createElement('pre')
  debugLog.id = 'debug-log'
  document.body.appendChild(debugLog)
  const log = (m, e=false) => debugLog.textContent = (e?'[ERR] ':'[OK] ') + m + '\n' + debugLog.textContent

  document.getElementById('btn-debug-session').addEventListener('click', async () => {
    const s = await supabase.auth.getSession()
    const u = await supabase.auth.getUser()
    log('session=' + JSON.stringify(s.data?.session?.user ?? null))
    log('user=' + JSON.stringify(u.data?.user ?? null))
  })

  async function ensureProfileExists() {
    const { data: { user }, error: uErr } = await supabase.auth.getUser()
    if (uErr || !user) { log('로그인 필요', true); return }

    // 내 프로필 존재 확인
    const { data, error } = await supabase.from('profiles')
      .select('id').eq('id', user.id).maybeSingle()
    if (error) { log('조회 오류: ' + error.message, true); return }

    if (!data) {
      // 없으면 생성
      const { error: upsertErr } = await supabase.from('profiles').upsert({
        id: user.id,
        email: user.email,
        last_login: new Date().toISOString()
      }, { onConflict: 'id' })
      if (upsertErr) log('upsert 실패: ' + upsertErr.message, true)
      else log('프로필 upsert 완료')
    } else {
      log('프로필 이미 존재')
    }
  }
  document.getElementById('btn-ensure-profile')
    .addEventListener('click', ensureProfileExists)
</script>
