<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Supabase 자가진단 (index2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    input, button { padding: 8px; }
    pre { background:#fafafa; border:1px solid #eee; padding:10px; min-height:140px; }
    .ok { color:#0a7 } .err { color:#c00 }
    .card { border:1px solid #ddd; border-radius:8px; padding:12px; margin:12px 0; }
  </style>
</head>
<body>
  <h1>Supabase 자가진단</h1>
  <p>이 페이지는 <b>테스트 전용</b>입니다. 원본 <code>index.html</code>은 수정하지 마세요.</p>

  <div class="card">
    <strong>세션 상태:</strong>
    <span id="session-text">확인 중…</span>
    <div style="margin-top:8px;">
      <button id="btn-debug-session">세션/유저 보기</button>
      <button id="btn-ensure-profile">프로필 강제 생성</button>
      <button id="btn-logout">로그아웃</button>
    </div>
  </div>

  <div class="card">
    <strong>로그인</strong>
    <div class="row" style="margin-top:8px;">
      <input type="email" id="email" placeholder="이메일" />
      <input type="password" id="password" placeholder="비밀번호" />
    </div>
    <div style="margin-top:8px;">
      <button id="btn-login">로그인</button>
    </div>
    <div id="login-msg" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <strong>로그</strong>
    <pre id="log"></pre>
  </div>

  <script type="module">
    // 1) Supabase SDK를 CDN으로 로드 (외부 파일 의존 제거)
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // 2) 여기를 본인 프로젝트 값으로 교체하세요
    const SUPABASE_URL = 'https://snxjcbaaysgfunpsohzg.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueGpjYmFheXNnZnVucHNvaHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1OTk3MzQsImV4cCI6MjA3MjE3NTczNH0.T8b9PpabXkCvwW2W57Qbr-h--JLZB6errlyP5IwsYyk'

    // 3) 클라이언트 생성
    const supabase = createClient(https://snxjcbaaysgfunpsohzg.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueGpjYmFheXNnZnVucHNvaHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1OTk3MzQsImV4cCI6MjA3MjE3NTczNH0.T8b9PpabXkCvwW2W57Qbr-h--JLZB6errlyP5IwsYyk)

    // 4) UI 핸들
    const $ = (id) => document.getElementById(id)
    const logEl = $('log')
    const sessionText = $('session-text')
    const loginMsg = $('login-msg')

    const log = (msg, err=false) => {
      logEl.textContent = (err ? '[ERR] ' : '[OK] ') + msg + '\n' + logEl.textContent
    }

    // 세션 표시
    async function refreshSession() {
      const { data, error } = await supabase.auth.getSession()
      if (error) {
        sessionText.innerHTML = `<span class="err">세션 조회 실패: ${error.message}</span>`
        return
      }
      if (data?.session?.user) {
        sessionText.innerHTML = `<span class="ok">로그인됨</span> (${data.session.user.email})`
      } else {
        sessionText.innerHTML = `<span class="err">로그아웃 상태</span>`
      }
    }

    // 프로필 없으면 만들어 넣기
    async function ensureProfileExists() {
      const { data: { user }, error: uErr } = await supabase.auth.getUser()
      if (uErr) { log('getUser 오류: ' + uErr.message, true); return }
      if (!user) { log('로그인 필요(세션 없음)', true); return }

      const { data, error } = await supabase
        .from('profiles')
        .select('id')
        .eq('id', user.id)
        .maybeSingle()

      if (error) { log('profiles 조회 오류: ' + error.message, true); return }

      if (!data) {
        const { error: e2 } = await supabase
          .from('profiles')
          .upsert({
            id: user.id,
            email: user.email,
            last_login: new Date().toISOString()
          }, { onConflict: 'id' })
        if (e2) log('upsert 실패: ' + e2.message, true)
        else log('profiles upsert 완료')
      } else {
        log('프로필 이미 존재')
      }
    }

    // 이벤트 바인딩
    $('btn-debug-session').addEventListener('click', async () => {
      const s = await supabase.auth.getSession()
      const u = await supabase.auth.getUser()
      log('session.user=' + JSON.stringify(s.data?.session?.user ?? null))
      log('user=' + JSON.stringify(u.data?.user ?? null))
    })

    $('btn-ensure-profile').addEventListener('click', ensureProfileExists)

    $('btn-logout').addEventListener('click', async () => {
      await supabase.auth.signOut()
      await refreshSession()
      log('로그아웃 완료')
    })

    $('btn-login').addEventListener('click', async () => {
      loginMsg.textContent = ''
      const email = $('email').value.trim()
      const password = $('password').value
      if (!email || !password) { loginMsg.innerHTML = '<span class="err">이메일/비밀번호 입력</span>'; return }

      const { error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) {
        loginMsg.innerHTML = `<span class="err">로그인 실패: ${error.message}</span>`
        log('로그인 실패: ' + error.message, true)
      } else {
        loginMsg.innerHTML = '<span class="ok">로그인 성공</span>'
        log('로그인 성공')
        await refreshSession()
        // 로그인 직후 프로필 보강
        await ensureProfileExists()
      }
    })

    // 초기 알림 + 세션 상태
    log('스크립트 로드 완료. 버튼을 눌러 세션/프로필을 확인하세요.')
    refreshSession()
  </script>

  <!-- 모듈이 전혀 실행되지 않을 때(브라우저/정책 문제) 표시 -->
  <noscript><p class="err">자바스크립트가 비활성화되어 있습니다.</p></noscript>
</body>
</html>
