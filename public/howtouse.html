<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — 사용법</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    :root { --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --pri:#5eead4; --border:#1e2230; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#e7edf5}
    a{color:var(--pri);text-decoration:none} a:hover{text-decoration:underline}
    header,main,footer{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-img{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1422}
    nav a{margin-left:16px;color:#cfd6e4}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}

    h1{margin:8px 0 2px;font-size:22px}
    p.muted{color:var(--muted);margin:2px 0 0}

    /* --- 그리드 --- */
    .howtouse{ margin-top:10px; }
    .howtouse-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    @media (max-width:1024px){ .howtouse-grid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .howtouse-grid{ grid-template-columns:1fr;} }

    .howtouse-item{
      position:relative;
      display:block;
      border-radius:10px;
      overflow:hidden;
      background:#0f1320;
      aspect-ratio:1/2;
      border:1px solid var(--border);
    }
    .howtouse-item img{
      width:100%; height:100%;
      object-fit:cover; display:block; image-rendering:auto;
      transition:transform .2s ease-out, opacity .2s ease-out; opacity:.98;
    }
    .howtouse-item:hover img{ transform:scale(1.02); opacity:1; }

    /* 오버레이 */
    .overlay{ position:absolute; inset:0; pointer-events:none; }
  .olabel{
  position:absolute;
  white-space:pre-wrap;
  color:#000;          /* 기본: 검정 */
  text-shadow:none;    /* 음영 제거 */
  filter:none;         /* 드랍섀도 제거 */
}
    .anchor-topstart  { transform: translate(0,0); }
    .anchor-topcenter { transform: translate(-50%,0); left:50%; }
    .anchor-topend    { transform: translate(-100%,0); }

    /* 디버그 on: 텍스트 박스 윤곽선 */
    .debug .olabel { outline:1px dashed rgba(255,255,255,.4); }
    footer{margin:30px auto 60px;text-align:center;color:var(--muted);font-size:14px}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo_small.jpg" alt="Measure Master" class="logo-img" loading="eager" fetchpriority="high" />
    <strong>Measure Master</strong>
  </div>
  <nav>
    <a href="/">홈</a>
    <a href="/howtouse.html">사용법</a>
    <a href="/reviews.html">사용후기</a>
    <a href="/privacy.html">개인정보처리방침</a>
  </nav>
</header>

<main>
  <section class="card howtouse">
    <h1>사용법</h1>
    <p class="muted">총 22장 · 이미지를 탭하면 원본이 새 탭에서 열립니다.</p>

    <div id="howtoGrid" class="howtouse-grid">
      <!-- 1 ~ 22: /images 경로로 통일 + onerror 대체 -->
      <!-- 복붙 가속을 위해 01~22 자동 생성은 JS에서 처리합니다 -->
    </div>
  </section>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // ===== 설정(필요 시 경로 조정) =====
  const IMG_DIR       = "/images/howtouse";           // 이미지 폴더
  const IMG_PREFIX    = "howtouse";                   // 파일 접두
  const IMG_EXTS      = ["jpg","png","jpeg","webp"];  // 폴백 순서
  const TOTAL_PAGES   = 22;

  const OVERLAYS_JSON = "/assets/data/howtouse_overlays.json";
  const STRINGS_KO    = "/assets/data/strings_ko.json";

  // ===== 유틸: 색상 변환 (#AARRGGBB / 0xAARRGGBB / RRGGBB) → rgba() =====
  function parseColorHex(hex) {
    if (!hex) return null;
    let s = String(hex).trim();
    if (s.startsWith("0x")) s = s.slice(2);
    if (s.startsWith("#"))  s = s.slice(1);
    if (s.length === 8) {
      const a = parseInt(s.slice(0,2),16)/255;
      const r = parseInt(s.slice(2,4),16);
      const g = parseInt(s.slice(4,6),16);
      const b = parseInt(s.slice(6,8),16);
      return `rgba(${r},${g},${b},${a})`;
    } else if (s.length === 6) {
      const r = parseInt(s.slice(0,2),16);
      const g = parseInt(s.slice(2,4),16);
      const b = parseInt(s.slice(4,6),16);
      return `rgb(${r},${g},${b})`;
    }
    return null;
  }
  function anchorClass(align="TopStart"){
    const a = align.toLowerCase();
    if (a.includes("center")) return "anchor-topcenter";
    if (a.includes("end"))    return "anchor-topend";
    return "anchor-topstart";
  }

  // ===== 이미지 엘리먼트 생성(+폴백) =====
  function createImageWithFallback(pageNum) {
    const img = new Image();
    img.alt   = `사용법 ${pageNum}`;
    img.loading = "lazy";

    // 순차 폴백
    const base = `${IMG_DIR}/${IMG_PREFIX}${pageNum}`;
    let idx = 0;
    function tryNext() {
      if (idx >= IMG_EXTS.length) {
        // 모든 확장자 실패 → 투명 SVG로 대체(아이콘 대신 깨끗하게)
        img.onerror = null;
        img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="1200"><rect width="100%" height="100%" fill="%230f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" opacity="0.4" font-size="20">이미지 없음</text></svg>';
        console.warn(`[howtouse] image not found: ${base}.[${IMG_EXTS.join(",")}]`);
        return;
      }
      img.src = `${base}.${IMG_EXTS[idx++]}`;
    }
    img.onerror = tryNext;
    tryNext();
    return img;
  }

  // ===== 오버레이 배치 =====
  function layoutLabels($item, labels) {
    const $overlay = $item.querySelector(".overlay");
    if (!$overlay || !labels?.length) return;
    $overlay.innerHTML = "";

    const rect = $item.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    const BASE_H = 600; // dy 기준
    const scale = H / BASE_H;

    labels.forEach(cfg => {
      const $label = document.createElement("div");
      $label.className = "olabel " + anchorClass(cfg.align);

      // 텍스트
      const text = window.__STRINGS?.[cfg.key] || cfg.key;
      $label.textContent = text;

      // 스타일
      if (cfg.bold) $label.style.fontWeight = "700";
      if (cfg.sizeSp)       $label.style.fontSize   = `${cfg.sizeSp}px`;
      if (cfg.lineHeightSp) $label.style.lineHeight = `${cfg.lineHeightSp}px`;
      if (cfg.textAlign)    $label.style.textAlign  = ({"Center":"center","End":"right","Start":"left"}[cfg.textAlign] || "left");
      const col = parseColorHex(cfg.colorHex);
      if (col) $label.style.color = col;
      if (cfg.maxWidthPercent) $label.style.maxWidth = `${cfg.maxWidthPercent*W}px`;

      // 위치: percent 우선, 아니면 dx/dy 스케일
      if (typeof cfg.xPercent === "number" && typeof cfg.yPercent === "number") {
        $label.style.left = `${cfg.xPercent*100}%`;
        $label.style.top  = `${cfg.yPercent*100}%`;
      } else {
        const dx = (cfg.dx||0) * scale;
        const dy = (cfg.dy||0) * scale;
        let leftPx = 0;
        const a = (cfg.align||"").toLowerCase();
        if (a.includes("center")) leftPx = W/2 + dx;
        else if (a.includes("end")) leftPx = W + dx;
        else leftPx = dx;
        $label.style.left = `${leftPx}px`;
        $label.style.top  = `${dy}px`;
      }
      $overlay.appendChild($label);
    });
  }

  // ===== 페이지번호 → 라벨그룹 매핑 생성 =====
  function buildOverlayMap(pages){
    const map = {};
    (pages||[]).forEach(group=>{
      const any = group.find(it => /^htu(\d{2})_/.test(it.key));
      if (any) {
        const num = any.key.match(/^htu(\d{2})_/)[1]; // "01".."22"
        map[num] = group;
      }
    });
    return map;
  }

  (async function init(){
    // 디버그 모드
    if (new URLSearchParams(location.search).get("debug") === "1") {
      document.body.classList.add("debug");
    }

    // JSON 로드
    let overlaysData = null, stringsKo = null;
    try { overlaysData = await fetch(OVERLAYS_JSON, {cache:"no-store"}).then(r=>r.json()); } catch(e){ console.warn("overlays load failed", e); }
    try { stringsKo    = await fetch(STRINGS_KO,    {cache:"no-store"}).then(r=>r.json()); } catch(e){ console.warn("strings load failed", e); }
    window.__STRINGS = stringsKo || {};

    const map = overlaysData?.pages ? buildOverlayMap(overlaysData.pages) : {};

    // 그리드 채우기(01~22 자동 생성)
    const grid = document.getElementById("howtoGrid");
    for (let i=1; i<=TOTAL_PAGES; i++){
      const num = String(i).padStart(2,"0");
      const a = document.createElement("a");
      a.className = "howtouse-item";
      a.target = "_blank";
      a.rel = "noopener";
      a.href = `${IMG_DIR}/${IMG_PREFIX}${num}.jpg`;

      const img = createImageWithFallback(num);
      const ol  = document.createElement("div");
      ol.className = "overlay";

      a.appendChild(img);
      a.appendChild(ol);
      grid.appendChild(a);

      // 최초 배치 + 리사이즈 대응
      const labels = map[num];
      if (labels) layoutLabels(a, labels);
      new ResizeObserver(()=> labels && layoutLabels(a, labels)).observe(a);
    }

    // 로고 등 연도 표시 유지
    document.getElementById('year').textContent = new Date().getFullYear();
  })();
</script>
</body>
</html>
