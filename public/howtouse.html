<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — 사용법</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <!-- 로고 프리로드 -->
  <link rel="preload" as="image" href="/images/mm_logo_small.jpg" />
  <style>
    :root { --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --pri:#5eead4; --border:#1e2230; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#e7edf5}
    a{color:var(--pri);text-decoration:none} a:hover{text-decoration:underline}
    header,main,footer{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-img{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1422}
    nav a{margin-left:16px;color:#cfd6e4}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}

    h1{margin:8px 0 2px;font-size:22px}
    p.muted{color:var(--muted);margin:2px 0 0}

    /* --- 그리드 --- */
    .howtouse{ margin-top:10px; }
    .howtouse-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    @media (max-width:1024px){ .howtouse-grid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .howtouse-grid{ grid-template-columns:1fr;} }

    .howtouse-item{
      position:relative;
      display:block;
      border-radius:10px;
      overflow:hidden;
      background:#0f1320;
      aspect-ratio:1/2;
      border:1px solid var(--border);
    }
    .howtouse-item img{
      width:100%; height:100%;
      object-fit:cover; display:block; image-rendering:auto;
      transition:transform .2s ease-out, opacity .2s ease-out; opacity:.98;
    }
    .howtouse-item:hover img{ transform:scale(1.02); opacity:1; }

    /* 오버레이 */
    .overlay{ position:absolute; inset:0; pointer-events:none; }
    /* 단순 스타일(검정, 음영 없음) */
    .olabel{
      position:absolute; white-space:pre-wrap;
      color:#000; text-shadow:none; filter:none;
    }
    .anchor-topstart  { transform: translate(0,0); }
    .anchor-topcenter { transform: translate(-50%,0); left:50%; }
    .anchor-topend    { transform: translate(-100%,0); }

    /* 디버그 on: 텍스트 박스 윤곽선 */
    .debug .olabel { outline:1px dashed rgba(0,0,0,.35); }
    footer{margin:30px auto 60px;text-align:center;color:var(--muted);font-size:14px}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <!-- 로고: 확장자 폴백 + 최종 SVG 폴백 -->
    <img
      src="/images/mm_logo_small.jpg"
      alt="Measure Master"
      class="logo-img"
      width="28" height="28"
      loading="eager" fetchpriority="high"
      onerror="
        if(!this.dataset.fbk){ this.dataset.fbk='png'; this.src='/images/mm_logo_small.png'; }
        else { this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2228%22 height=%2228%22><rect width=%2228%22 height=%2228%22 rx=%226%22 fill=%22%230e1422%22/><text x=%2250%25%22 y=%2254%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 font-size=%2214%22 fill=%22%235eead4%22>MM</text></svg>'; }
      "
    />
    <strong>Measure Master</strong>
  </div>
  <nav>
    <a href="/">홈</a>
    <a href="/howtouse.html">사용법</a>
    <a href="/reviews.html">사용후기</a>
    <a href="/privacy.html">개인정보처리방침</a>
  </nav>
</header>

<main>
  <section class="card howtouse">
    <h1>사용법</h1>
    <p class="muted">총 22장 · 이미지를 탭하면 원본이 새 탭에서 열립니다.</p>

    <div id="howtoGrid" class="howtouse-grid"></div>
  </section>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // ===== 설정 =====
  const IMG_DIR       = "/images/howtouse";
  const IMG_PREFIX    = "howtouse";
  const IMG_EXTS      = ["jpg","png","jpeg","webp"];
  const TOTAL_PAGES   = 22;

  // 파일명 변경(…_pc.json) + 기존 이름 폴백
  const OVERLAY_URLS  = ["/assets/data/howtouse_overlays_pc.json", "/assets/data/howtouse_overlays.json"];
  const STRINGS_URLS  = ["/assets/data/strings_ko_pc.json",       "/assets/data/strings_ko.json"];

  // ===== 유틸 =====
  function parseColorHex(hex){
    if (!hex) return null;
    let s = String(hex).trim();
    if (s.startsWith("0x")) s = s.slice(2);
    if (s.startsWith("#"))  s = s.slice(1);
    if (s.length === 8) {
      const a = parseInt(s.slice(0,2),16)/255;
      const r = parseInt(s.slice(2,4),16);
      const g = parseInt(s.slice(4,6),16);
      const b = parseInt(s.slice(6,8),16);
      return `rgba(${r},${g},${b},${a})`;
    } else if (s.length === 6) {
      const r = parseInt(s.slice(0,2),16), g = parseInt(s.slice(2,4),16), b = parseInt(s.slice(4,6),16);
      return `rgb(${r},${g},${b})`;
    }
    return null;
  }
  function anchorClass(align="TopStart"){
    const a = align.toLowerCase();
    if (a.includes("center")) return "anchor-topcenter";
    if (a.includes("end"))    return "anchor-topend";
    return "anchor-topstart";
  }
  async function fetchFirst(urls){
    for (const u of urls){
      try{
        const r = await fetch(u, { cache:"no-store" });
        if (r.ok) return await r.json();
      }catch(e){}
    }
    return null;
  }
  function createImageWithFallback(pageNum){
    const img = new Image();
    img.alt = `사용법 ${pageNum}`;
    img.loading = "lazy";
    const base = `${IMG_DIR}/${IMG_PREFIX}${pageNum}`;
    let i = 0;
    img.onerror = function(){
      if (i < IMG_EXTS.length) img.src = `${base}.${IMG_EXTS[i++]}`;
      else {
        img.onerror = null;
        img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="1200"><rect width="100%" height="100%" fill="%230f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" opacity="0.4" font-size="20">이미지 없음</text></svg>';
      }
    };
    img.src = `${base}.${IMG_EXTS[i++]}`; // 첫 시도
    return img;
  }

  function layoutLabels($item, labels){
    const $overlay = $item.querySelector(".overlay");
    if (!$overlay || !labels?.length) return;
    $overlay.innerHTML = "";

    const rect = $item.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    const BASE_H = 600;  // dy 기준
    const scale = H / BASE_H;

    labels.forEach(cfg=>{
      const el = document.createElement("div");
      el.className = "olabel " + anchorClass(cfg.align);
      const text = window.__STRINGS?.[cfg.key] || cfg.key;
      el.textContent = text;

      if (cfg.bold) el.style.fontWeight = "700";
      if (cfg.sizeSp)       el.style.fontSize   = `${cfg.sizeSp}px`;
      if (cfg.lineHeightSp) el.style.lineHeight = `${cfg.lineHeightSp}px`;
      if (cfg.textAlign)    el.style.textAlign  = ({"Center":"center","End":"right","Start":"left"}[cfg.textAlign] || "left");
      const col = parseColorHex(cfg.colorHex);
      if (col) el.style.color = col; // 지정된 항목만 색상 오버라이드
      if (cfg.maxWidthPercent) el.style.maxWidth = `${cfg.maxWidthPercent*W}px`;

      if (typeof cfg.xPercent === "number" && typeof cfg.yPercent === "number") {
        el.style.left = `${cfg.xPercent*100}%`;
        el.style.top  = `${cfg.yPercent*100}%`;
      } else {
        const dx = (cfg.dx||0) * scale;
        const dy = (cfg.dy||0) * scale;
        const a = (cfg.align||"").toLowerCase();
        let leftPx = 0;
        if (a.includes("center")) leftPx = W/2 + dx;
        else if (a.includes("end")) leftPx = W + dx;
        else leftPx = dx;
        el.style.left = `${leftPx}px`;
        el.style.top  = `${dy}px`;
      }
      $overlay.appendChild(el);
    });
  }

  function buildOverlayMap(pages){
    const map = {};
    (pages||[]).forEach(group=>{
      const any = group.find(it => /^htu(\d{2})_/.test(it.key));
      if (any) {
        const num = any.key.match(/^htu(\d{2})_/)[1];
        map[num] = group;
      }
    });
    return map;
  }

  (async function init(){
    if (new URLSearchParams(location.search).get("debug")==="1") document.body.classList.add("debug");

    const overlaysData = await fetchFirst(OVERLAY_URLS);
    const stringsKo    = await fetchFirst(STRINGS_URLS);
    window.__STRINGS = stringsKo || {};
    const map = overlaysData?.pages ? buildOverlayMap(overlaysData.pages) : {};

    const grid = document.getElementById("howtoGrid");
    for (let i=1; i<=22; i++){
      const num = String(i).padStart(2,"0");
      const a = document.createElement("a");
      a.className = "howtouse-item";
      a.target = "_blank"; a.rel = "noopener";
      a.href = `${IMG_DIR}/${IMG_PREFIX}${num}.jpg`;

      const img = createImageWithFallback(num);
      const ol  = document.createElement("div"); ol.className = "overlay";

      a.appendChild(img);
      a.appendChild(ol);
      grid.appendChild(a);

      const labels = map[num];
      if (labels) layoutLabels(a, labels);
      new ResizeObserver(()=> labels && layoutLabels(a, labels)).observe(a);
    }

    document.getElementById('year').textContent = new Date().getFullYear();
  })();
</script>
</body>
</html>
