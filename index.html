<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure-Master • Sign in</title>
  <style>
    :root {
      --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --acc:#38bdf8; --err:#ef4444; --ok:#22c55e;
      --card:#111827; --input:#0b1220; --border:#1f2937;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:32px 20px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:24px}
    header .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#22c55e,#38bdf8)}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media (max-width: 800px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    .card h2{font-size:16px;margin:0 0 12px}
    .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    label{font-size:13px;color:var(--muted)}
    input{
      background:var(--input); color:var(--fg);
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none;
    }
    input:focus{border-color:var(--acc); box-shadow:0 0 0 3px #38bdf833}
    small#pw-hint{min-height:18px}
    .btns{display:flex;flex-wrap:wrap; gap:10px}
    button{
      background:#1f2937; color:var(--fg); border:1px solid var(--border);
      border-radius:10px; padding:10px 14px; cursor:pointer;
    }
    button:hover{border-color:var(--acc)}
    button:disabled{opacity:.5; cursor:not-allowed}
    .status{margin-top:8px}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    pre#log{background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:12px;max-height:220px;overflow:auto}
    footer{margin-top:26px;color:var(--muted);font-size:13px}
    a{color:#93c5fd;text-decoration:none} a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Measure-Master</h1>
        <div class="muted">회원가입 / 로그인</div>
      </div>
    </header>

    <div class="grid">
      <!-- 좌: 인증 카드 -->
      <section class="card" aria-labelledby="auth-title">
        <h2 id="auth-title">이메일 로그인</h2>

        <div class="row">
          <label for="email">이메일</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required />
        </div>

        <div class="row">
          <label for="password">비밀번호</label>
          <input id="password" type="password" placeholder="Password" autocomplete="new-password" required />
        </div>

        <div class="row">
          <label for="password2">비밀번호 확인</label>
          <input id="password2" type="password" placeholder="Confirm password" autocomplete="new-password" required />
          <small id="pw-hint" class="muted"></small>
        </div>

        <div class="btns">
          <button id="btn-signup" disabled>회원가입</button>
          <button id="btn-login">로그인</button>
          <button id="btn-logout">로그아웃</button>
          <button id="btn-debug-session" title="세션/유저 디버그">세션상태</button>
        </div>

        <div class="status">세션상태: <span id="session-text" class="muted">확인 중…</span></div>
      </section>

      <!-- 우: 로그/도움말 -->
      <section class="card" aria-labelledby="log-title">
        <h2 id="log-title">진단 로그</h2>
        <pre id="log">페이지 로드 중…</pre>
        <footer>
          <div>개발 중엔 Supabase 대시보드 → <b>Auth &gt; Providers &gt; Email</b> 에서
            <b>Enable email confirmations = OFF</b> 권장.</div>
          <div>운영 전환 시 다시 ON으로 돌리고, 리디렉트/템플릿 설정하세요.</div>
        </footer>
      </section>
    </div>
  </div>

  <noscript>이 페이지는 JavaScript가 필요합니다.</noscript>

  <!-- Supabase 연결/로직 -->
  <script type="module">
    // ===== DOM 유틸 =====
    const $ = (id)=>document.getElementById(id)
    const log = (m, err=false)=>{ const el=$('log'); if(el) el.textContent=(err?'[ERR] ':'[OK] ')+m+'\n'+el.textContent }
    const setSession = (html)=>{ const el=$('session-text'); if (el) el.innerHTML = html }

    // ===== SDK 로드 =====
    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2?target=es2020')
    log('SDK import OK')

    // ===== 프로젝트 키 (이 두 줄만 교체) =====
    const SUPABASE_URL = 'https://snxjcbaaysgfunpsohzg.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueGpjYmFheXNnZnVucHNvaHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1OTk3MzQsImV4cCI6MjA3MjE3NTczNH0.T8b9PpabXkCvwW2W57Qbr-h--JLZB6errlyP5IwsYyk'

    // ===== 클라이언트 =====
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    log('client created')

    // ===== 비밀번호 확인/검증 =====
    const minLen = 6 // Auth > Providers > Email 정책과 동일하게
    function validatePwFields(){
      const pw  = $('password')?.value ?? ''
      const pw2 = $('password2')?.value ?? ''
      const hint = $('pw-hint')
      let ok = true, msg = ''
      if (pw.length < minLen) { ok=false; msg=`비밀번호는 최소 ${minLen}자 이상이어야 합니다.` }
      else if (pw !== pw2)    { ok=false; msg='비밀번호가 일치하지 않습니다.' }
      if (hint) { hint.textContent = msg; hint.style.color = ok ? 'var(--muted)' : 'var(--err)' }
      const btn = $('btn-signup'); if (btn) btn.disabled = !ok
      return ok
    }
    ;['password','password2'].forEach(id=>$(id)?.addEventListener('input', validatePwFields))

    // ===== 세션 표시 =====
    async function refreshSession(){
      const { data, error } = await supabase.auth.getSession()
      if (error) { setSession('<span class="err">세션 조회 실패</span>'); log('getSession: '+error.message, true); return }
      const user = data?.session?.user
      if (user) { setSession(`<span class="ok">로그인됨</span> (${user.email})`); log('session OK: '+user.email) }
      else { setSession('<span class="err">로그아웃</span>'); log('no session') }
    }

    // ===== 버튼 핸들러 =====
    $('btn-signup')?.addEventListener('click', async ()=>{
      if (!validatePwFields()) return
      const email = ($('email')?.value || '').trim()
      const password = $('password')?.value || ''
      if (!email || !password) { log('이메일/비밀번호 입력', true); return }

      const { data, error } = await supabase.auth.signUp({ email, password })
      if (error) { log('회원가입 실패: '+error.message, true); return }

      // 이메일 확인 OFF면 즉시 세션 생성
      log('회원가입 완료')
      await refreshSession()
    })

    $('btn-login')?.addEventListener('click', async ()=>{
      const email = ($('email')?.value || '').trim()
      const password = $('password')?.value || ''
      if (!email || !password) { log('이메일/비밀번호 입력', true); return }

      const { error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) { log('로그인 실패: '+error.message, true); return }
      log('로그인 성공')
      await refreshSession()
    })

    $('btn-logout')?.addEventListener('click', async ()=>{
      await supabase.auth.signOut()
      log('로그아웃 완료')
      await refreshSession()
    })

    $('btn-debug-session')?.addEventListener('click', async ()=>{
      const s = await supabase.auth.getSession()
      const u = await supabase.auth.getUser()
      log('session.user=' + JSON.stringify(s.data?.session?.user ?? null))
      log('user=' + JSON.stringify(u.data?.user ?? null))
    })

    // cross-tab / 초기 표시
    supabase.auth.onAuthStateChange(() => refreshSession())
    await refreshSession()
  </script>
</body>
</html>
