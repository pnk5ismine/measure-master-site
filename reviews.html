<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master â€” ì‚¬ìš©í›„ê¸°</title>
  <meta name="description" content="Measure Master ì‚¬ìš©ìë“¤ì´ ì˜¬ë¦° í›„ê¸°ì™€ ì‚¬ì§„" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    :root { --bg:#0b0d12; --card:#121622; --muted:#9aa4b2; --pri:#5eead4; --border:#1e2230; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#e7edf5}
    a{color:var(--pri);text-decoration:none} a:hover{text-decoration:underline}
    header,main,footer{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-img{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1422}
    nav a{margin-left:16px;color:#cfd6e4}
    .muted{color:var(--muted)}
    .pill{background:#0f1320;border:1px solid var(--border);border-radius:999px;padding:4px 8px}
    footer{margin:30px auto 60px;text-align:center;color:var(--muted);font-size:14px}

    /* ëª¨ë°”ì¼ í—¤ë” ì •ë¦¬(ë©”ë‰´ ë­‰ì¹¨ ë°©ì§€) */
    @media (max-width:640px){
      header{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
      .brand{order:1}
      .lang{order:2;margin-left:auto;width:100%;display:flex;justify-content:flex-end;gap:6px}
      header nav{order:3;width:100%;display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
      header nav::-webkit-scrollbar{display:none}
      header nav a{margin:0;flex:0 0 auto;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1320;color:#e7edf5;font-size:13px;line-height:1.1;overflow:hidden;text-overflow:ellipsis}
    }

    /* í˜ì´ì§€ ë ˆì´ì•„ì›ƒ */
    .layout{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:1024px){ .layout{grid-template-columns:1fr .9fr;align-items:start} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    .section-title{margin:0 0 8px;font-size:20px}
    .section-sub{margin:0 0 14px;color:var(--muted);font-size:14px}

    /* ì‘ì„± í¼ */
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0 2px}
    input[type="text"], textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:#0f1320;color:#e7edf5
    }
    textarea{min-height:120px;resize:vertical;white-space:pre-wrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .btn{padding:10px 14px;background:#1d2639;color:#e7edf5;border:1px solid var(--border);border-radius:12px;cursor:pointer}
    .btn:hover{background:#223049}
    .btn.secondary{background:#0f1320}
    .status{font-size:13px;color:var(--muted);margin-top:6px}
    .thumb{width:100%;max-height:360px;object-fit:contain;border:1px dashed var(--border);border-radius:12px;background:#0f1320}

    /* ëª©ë¡ */
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    .item{background:#0f1320;border:1px solid var(--border);border-radius:14px;padding:14px}
    .item-head{display:flex;gap:8px;align-items:baseline}
    .item-title{margin:0;font-size:18px}
    .item-meta{margin-left:auto;font-size:12px;color:var(--muted)}
    .item-body{white-space:pre-wrap;margin:8px 0 0}
    .item-img{width:100%;max-height:500px;object-fit:contain;border-radius:10px;margin-top:10px;background:#0b0d12}
    .item-actions{display:flex;gap:8px;margin-top:10px}
    .danger{border-color:#7f1d1d;background:#2d1414;color:#fbb}
  </style>

<style id="white-cards-theme">
  /* ì¹´ë“œ/ëª©ë¡ì„ í™”ì´íŠ¸ë¡œ, ë³¸ë¬¸ ë°°ê²½ì€ ê¸°ì¡´ ë‹¤í¬ ìœ ì§€ */
  .card{
    background:#fff !important; color:#111 !important;
    border:1px solid #e5e7eb !important; border-radius:16px;
    box-shadow:0 1px 2px rgba(0,0,0,.08);
  }
  .item{
    background:#fff !important; color:#111 !important;
    border:1px solid #e5e7eb !important; border-radius:14px;
    box-shadow:0 1px 2px rgba(0,0,0,.06);
  }
  .item-title{ color:#111 !important; }
  .item-body{ color:#111 !important; }
  .item-img{ background:#fff !important; }

  /* ì…ë ¥ ìš”ì†Œë„ í™”ì´íŠ¸ë¡œ */
  input[type="text"], input[type="email"], input[type="password"], textarea{
    background:#fff !important; color:#111 !important; border:1px solid #e5e7eb !important;
  }
  .thumb{ background:#fff !important; border:1px dashed #e5e7eb !important; }

  /* ë²„íŠ¼ì€ ëŒ€ë¹„ ìœ ì§€(ì„ íƒì ìœ¼ë¡œ ì¡°ì •) */
  .btn{ background:#111; color:#fff; border:1px solid #111; }
  .btn:hover{ background:#222; }
  .btn.secondary{ background:#f9fafb; color:#111; border:1px solid #e5e7eb; }
</style>

</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo_small.jpg" alt="Measure Master" class="logo-img" />
    <strong>Measure Master</strong>
    <span class="pill">í›„ê¸°</span>
  </div>
  <nav>
    <a href="/">í™ˆ</a>
    <a href="/howtouse.html">ì‚¬ìš©ë²•</a>
    <a href="/reviews.html">ì‚¬ìš©í›„ê¸°</a>
    <a href="/privacy.html">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
  </nav>
  <div class="lang">
    <button type="button" class="btn secondary" style="padding:6px 10px">ğŸ‡°ğŸ‡·</button>
    <button type="button" class="btn secondary" style="padding:6px 10px">ğŸ‡¬ğŸ‡§</button>
  </div>
</header>

<main>
  <div class="layout">
    <!-- ì‘ì„± ì¹´ë“œ -->
    <section class="card">
      <h2 class="section-title">í›„ê¸° ì‘ì„±</h2>
      <p class="section-sub">ì˜ê²¬ê³¼ í˜„ì¥ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”. (ì´ë¯¸ì§€ëŠ” ì„ íƒì‚¬í•­)</p>

      <div id="auth-info" class="status">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>

      <form id="form" hidden>
        <div class="field">
          <label for="title">ì œëª©</label>
          <input id="title" name="title" type="text" maxlength="100" required placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="field">
          <label for="content">ë‚´ìš©</label>
          <textarea id="content" name="content" maxlength="5000" placeholder="ì‚¬ìš© ê²½í—˜, ê°œì„  ì˜ê²¬ ë“±ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”"></textarea>
        </div>

        <div class="field">
          <label for="image">ì‚¬ì§„ (ìµœëŒ€ 1ì¥, JPG/PNG, 3MB ì´í•˜)</label>
          <div class="row">
            <input id="image" name="image" type="file" accept="image/*">
            <button type="button" id="clearImg" class="btn secondary">ì‚­ì œ</button>
          </div>
          <img id="preview" class="thumb" alt="" hidden>
          <div class="hint">ì €ì‘ê¶Œ ë¬¸ì œ ì—†ëŠ” ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>
        </div>

        <div class="row">
          <button type="submit" class="btn">ë“±ë¡</button>
          <button type="button" id="logout" class="btn secondary" hidden>ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div id="formStatus" class="status"></div>
      </form>

      <div id="loginBox" hidden>
        <p class="muted">ë¡œê·¸ì¸ í›„ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.</p>
        <div class="row" style="gap:6px">
          <input id="login-email" type="email" placeholder="you@example.com" style="min-width:240px">
          <input id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="min-width:160px">
          <button id="btn-login" class="btn">ë¡œê·¸ì¸</button>
          <button id="btn-signup" class="btn secondary">ê°€ì…</button>
        </div>
        <div id="loginStatus" class="status"></div>
      </div>
    </section>

    <!-- ëª©ë¡ ì¹´ë“œ -->
    <section class="card">
      <h2 class="section-title">ì‚¬ìš©ì í›„ê¸°</h2>
      <p class="section-sub">ìµœì‹ ìˆœ Â· ë¹„ë¡œê·¸ì¸ë„ ì—´ëŒ ê°€ëŠ¥</p>
      <div id="list" class="list" aria-live="polite"></div>
      <div class="row" style="margin-top:8px">
        <button id="more" class="btn secondary">ë”ë³´ê¸°</button>
        <div id="listStatus" class="status"></div>
      </div>
    </section>
  </div>
</main>

<footer>
  Â© <span id="year"></span> Measure Master. All rights reserved.
</footer>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === ë³¸ì¸ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´ ê°€ëŠ¥(ì§€ê¸ˆì€ index.htmlê³¼ ë™ì¼ ê°’ ì‚¬ìš©) ===
  const SUPABASE_URL  = "https://snxjcbaaysgfunpsohzg.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueGpjYmFheXNnZnVucHNvaHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1OTk3MzQsImV4cCI6MjA3MjE3NTczNH0.T8b9PpabXkCvwW2W57Qbr-h--JLZB6errlyP5IwsYyk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const $ = s => document.querySelector(s);
  const list = $("#list");
  const form = $("#form");
  const loginBox = $("#loginBox");
  const authInfo = $("#auth-info");
  const formStatus = $("#formStatus");
  const loginStatus = $("#loginStatus");
  const preview = $("#preview");
  const imageInput = $("#image");
  $("#year").textContent = new Date().getFullYear();

  // ëª©ë¡ í˜ì´ì§•
  const PAGE_SIZE = 10;
  let pageFrom = 0;

  // ìœ í‹¸
  function maskEmail(email=""){
    const m = String(email).split("@");
    if(m.length<2) return email;
    return m[0].slice(0,2) + "***@" + m[1];
  }
  function fmtDate(s){ try{ return new Date(s).toLocaleString("ko-KR"); }catch{ return s; } }

  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
  imageInput.addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(!f){ preview.hidden = true; preview.src=""; return; }
    if(!/^image\//.test(f.type)){ alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); imageInput.value=""; return; }
    if(f.size > 3*1024*1024){ alert("3MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); imageInput.value=""; return; }
    const url = URL.createObjectURL(f);
    preview.src = url; preview.hidden = false;
  });
  $("#clearImg").addEventListener("click", ()=>{
    imageInput.value = ""; preview.hidden = true; preview.src = "";
  });

  // ì¸ì¦ UI
  async function refreshAuthUI(){
    const { data:{ session } } = await sb.auth.getSession();
    if(session?.user){
      authInfo.textContent = `ë¡œê·¸ì¸: ${session.user.email}`;
      form.hidden = false; loginBox.hidden = true;
      $("#logout").hidden = false;
    }else{
      authInfo.textContent = "ë¡œê·¸ì•„ì›ƒ ìƒíƒœ";
      form.hidden = true; loginBox.hidden = false;
      $("#logout").hidden = true;
    }
  }

  // ë¡œê·¸ì¸/ê°€ì…/ë¡œê·¸ì•„ì›ƒ
  $("#btn-login").addEventListener("click", async ()=>{
    loginStatus.textContent = "ë¡œê·¸ì¸ ì¤‘â€¦";
    const email = $("#login-email").value.trim();
    const password = $("#login-password").value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    loginStatus.textContent = error ? `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}` : "ë¡œê·¸ì¸ ì„±ê³µ";
    await refreshAuthUI();
  });
  $("#btn-signup").addEventListener("click", async ()=>{
    loginStatus.textContent = "ê°€ì… ì¤‘â€¦";
    const email = $("#login-email").value.trim();
    const password = $("#login-password").value;
    if(password.length < 8){ loginStatus.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ"; return; }
    const { error } = await sb.auth.signUp({ email, password });
    loginStatus.textContent = error ? `ê°€ì… ì‹¤íŒ¨: ${error.message}` : "ê°€ì… ì™„ë£Œ(ë©”ì¼ ì¸ì¦ ì„¤ì •ì‹œ ë©”ì¼ í™•ì¸)";
  });
  $("#logout").addEventListener("click", async ()=>{
    await sb.auth.signOut(); await refreshAuthUI();
  });

  // í›„ê¸° ë“±ë¡
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    formStatus.textContent = "ë“±ë¡ ì¤‘â€¦";
    const { data:{ session } } = await sb.auth.getSession();
    if(!session?.user){ alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }

    const title = $("#title").value.trim();
    const content = $("#content").value.trim();
    if(!title || !content){ formStatus.textContent = "ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."; return; }

    let image_path = null, image_url = null;

    const file = imageInput.files?.[0] || null;
    if(file){
      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const safeExt = ["jpg","jpeg","png","webp","gif"].includes(ext) ? ext : "jpg";
      const key = `${session.user.id}/${Date.now()}_${Math.random().toString(36).slice(2)}.${safeExt}`;

      const up = await sb.storage.from("reviews").upload(key, file, { upsert:false, cacheControl:"3600" });
      if(up.error){ formStatus.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + up.error.message; return; }
      image_path = key;
      const pub = sb.storage.from("reviews").getPublicUrl(key);
      image_url = pub.data.publicUrl; // ë²„í‚·ì„ publicìœ¼ë¡œ ë§Œë“¤ì—ˆì„ ë•Œ
    }

const username =
  (session.user.user_metadata?.full_name) ||
  (session.user.email ? session.user.email.split('@')[0] : null) ||
  'ìµëª…';


// ê¸°ì¡´ insertì— username í•„ë“œë¥¼ ì¶”ê°€
const ins = await sb.from("reviews").insert({
  title, content,
  image_path, image_url,
  user_id: session.user.id,
  author_email: session.user.email,
  username                      // â† ì¶”ê°€
}).select().single();

    if(ins.error){ formStatus.textContent = "ë“±ë¡ ì‹¤íŒ¨: " + ins.error.message; return; }
    formStatus.textContent = "ë“±ë¡ ì™„ë£Œ!";
    // í¼ ì´ˆê¸°í™”
    $("#title").value = ""; $("#content").value = ""; imageInput.value=""; preview.hidden=true; preview.src="";
    // ëª©ë¡ ë§¨ ì•ì— ì¶”ê°€
    prependItem(ins.data, session.user);
  });

  // í›„ê¸° ëª©ë¡ ë¡œë“œ
  async function loadList(){
    $("#listStatus").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
    const to = pageFrom + PAGE_SIZE - 1;
    const { data, error } = await sb
      .from("reviews")
      .select("*")
      .order("created_at", { ascending:false })
      .range(pageFrom, to);

    if(error){ $("#listStatus").textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message; return; }
    data.forEach(row => appendItem(row));
    pageFrom += data.length;
    $("#listStatus").textContent = data.length < PAGE_SIZE ? "ë§ˆì§€ë§‰ í˜ì´ì§€" : "";
    $("#more").disabled = data.length < PAGE_SIZE;
  }

  function ownerButtons(row, currentUser){
    if(!currentUser || row.user_id !== currentUser.id) return "";
    return `<button data-id="${row.id}" class="btn danger js-del">ì‚­ì œ</button>`;
  }

  function appendItem(row){
    const div = document.createElement("div");
    div.className = "item";
    div.dataset.id = row.id;
    div.innerHTML = `
      <div class="item-head">
        <h3 class="item-title">${escapeHtml(row.title)}</h3>
        <div class="item-meta">${maskEmail(row.author_email)} Â· ${fmtDate(row.created_at)}</div>
      </div>
      <div class="item-body">${escapeHtml(row.content)}</div>
      ${row.image_url ? `<img class="item-img" src="${row.image_url}" alt="">` : ``}
      <div class="item-actions"></div>
    `;
    list.appendChild(div);
    attachOwnerActions(div, row);
  }

  function prependItem(row, currentUser){
    const div = document.createElement("div");
    div.className = "item";
    div.dataset.id = row.id;
    div.innerHTML = `
      <div class="item-head">
        <h3 class="item-title">${escapeHtml(row.title)}</h3>
        <div class="item-meta">${maskEmail(row.author_email)} Â· ë°©ê¸ˆ ì „</div>
      </div>
      <div class="item-body">${escapeHtml(row.content)}</div>
      ${row.image_url ? `<img class="item-img" src="${row.image_url}" alt="">` : ``}
      <div class="item-actions">${ownerButtons(row, currentUser)}</div>
    `;
    list.prepend(div);
    bindDelete(div);
  }

  function attachOwnerActions(div, row){
    sb.auth.getSession().then(({data:{session}})=>{
      const user = session?.user;
      div.querySelector(".item-actions").innerHTML = ownerButtons(row, user);
      bindDelete(div);
    });
  }

  function bindDelete(container){
    const btn = container.querySelector(".js-del");
    if(!btn) return;
    btn.addEventListener("click", async ()=>{
      if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      btn.disabled = true;
      const id = btn.getAttribute("data-id");
      // 1) ë ˆì½”ë“œ ì¡°íšŒí•´ì„œ ì´ë¯¸ì§€ ê²½ë¡œ ì•Œì•„ë‚´ê¸°
      const { data: row } = await sb.from("reviews").select("image_path").eq("id", id).single();
      // 2) ë ˆì½”ë“œ ì‚­ì œ(ì†Œìœ ìë§Œ í—ˆìš©í•˜ëŠ” RLS í•„ìš”)
      const del = await sb.from("reviews").delete().eq("id", id);
      if(del.error){ alert("ì‚­ì œ ì‹¤íŒ¨: " + del.error.message); btn.disabled=false; return; }
      // 3) ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ ì‚­ì œ(ê¶Œí•œ ì •ì±… í•„ìš”)
      if(row?.image_path){
        await sb.storage.from("reviews").remove([row.image_path]);
      }
      container.remove();
    });
  }

  function escapeHtml(s=""){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  $("#more").addEventListener("click", loadList);

  // ì´ˆê¸°í™”
  (async function(){
    await refreshAuthUI();
    await loadList();
  })();
</script>
</body>
</html>
