<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — User reviews</title>
  <meta name="description" content="User reviews and feedback for Measure Master." />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Favicon / logo -->
  <link rel="icon" type="image/png" href="/images/mm_logo_small.png" />
  <link rel="shortcut icon" type="image/png" href="/images/mm_logo_small.png" />

  <style>
    :root {
      --bg:#0b0d12;
      --card:#ffffff;
      --border:#e5e7eb;
      --muted:#6b7280;
      --text:#111827;
      --accent:#0ea5e9;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif;
      background:var(--bg);
      color:#e7edf5;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header, main, footer {
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }

    /* Header */
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-img {
      width:28px;
      height:28px;
      border-radius:6px;
      object-fit:contain;
      background:#0e1422;
      box-shadow:0 0 0 1px rgba(148,163,184,.4), 0 8px 24px rgba(15,23,42,.9);
    }
    .brand strong {
      font-size:18px;
      letter-spacing:-0.02em;
    }
    .brand-sub {
      margin-left:6px;
      font-size:12px;
      color:#9ca3af;
    }

    nav {
      display:flex;
      align-items:center;
      gap:12px;
      font-size:13px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    nav a {
      color:#cfd6e4;
      text-decoration:none;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    nav a:hover {
      border-color:rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      text-decoration:none;
    }
    nav a[aria-current="page"] {
      border-color:rgba(56,189,248,.85);
      background:rgba(15,23,42,.96);
      color:#e0f2fe;
      font-weight:600;
    }

    main {
      flex:1;
    }

    /* Layout: left = login status, right = reviews */
    .layout {
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
      align-items:flex-start;
    }
    @media (min-width:1024px) {
      .layout {
        grid-template-columns:minmax(260px, 1fr) minmax(0, 2.2fr);
      }
    }

    .card {
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      box-shadow:0 1px 3px rgba(15,23,42,.12);
    }

    h1 {
      margin:0 0 8px;
      font-size:20px;
      letter-spacing:-0.02em;
    }
    h2 {
      margin:0 0 8px;
      font-size:16px;
      letter-spacing:-0.01em;
    }
    .muted {
      color:var(--muted);
      font-size:13px;
      margin:0 0 8px;
    }

    /* Left: login status */
    #leftAuth .hint {
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }
    #authStatus {
      font-size:13px;
      margin-top:4px;
    }

    /* Buttons */
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #111827;
      background:#111827;
      color:#ffffff;
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
      gap:6px;
    }
    .btn.secondary {
      background:#f9fafb;
      color:#111827;
      border-color:var(--border);
    }
    .btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }

    /* Reviews table */
    .table {
      width:100%;
      border-collapse:collapse;
    }
    .table th,
    .table td {
      border-bottom:1px solid #e5e7eb;
      padding:10px 8px;
      vertical-align:top;
      font-size:14px;
    }
    .table th {
      font-weight:600;
      color:#111827;
      text-align:left;
    }
    .table tr:hover {
      background:#f9fafb;
    }
    .cell-no {
      width:56px;
      color:#6b7280;
      font-size:13px;
    }
    .cell-nick {
      width:120px;
      font-size:13px;
      color:#111827;
    }
    .cell-stats {
      width:90px;
      text-align:center;
      color:#6b7280;
      font-size:13px;
    }
    .cell-time {
      width:170px;
      text-align:right;
      color:#6b7280;
      font-size:13px;
    }
    .cell-body {
      word-break:break-word;
      white-space:normal;
      font-size:14px;
    }
    .cell-body .m-line1 {
      font-weight:600;
      margin-bottom:4px;
    }
    .cell-body .m-line2 {
      display:flex;
      justify-content:flex-start;
      gap:12px;
      font-size:12px;
      color:#6b7280;
    }
    .notice-tag {
      color:#2563eb;
      font-weight:700;
      margin-right:6px;
      font-size:12px;
    }
    .table tr.notice td {
      color:#1d4ed8;
    }

    .list-footer {
      border-top:1px solid #e5e7eb;
      padding-top:10px;
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
    }
    #listLoginHint {
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }

    /* Write form */
    .field {
      display:flex;
      flex-direction:column;
      gap:4px;
      margin:8px 0;
      font-size:13px;
    }
    .field label {
      color:#111827;
      font-weight:500;
    }
    .field input[type="text"],
    .field textarea {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      font-size:14px;
      resize:vertical;
    }
    .field textarea {
      min-height:140px;
    }
    #formStatus {
      font-size:12px;
      color:#6b7280;
    }

    .write-actions {
      border-top:1px solid #e5e7eb;
      margin-top:12px;
      padding-top:10px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
    }

    footer {
      margin:30px auto 40px;
      text-align:center;
      color:#9ca3af;
      font-size:13px;
    }
    footer a {
      color:#9ca3af;
      text-decoration:none;
    }
    footer a:hover {
      text-decoration:underline;
    }

    /* Mobile: stack layout, table to card-like view */
    @media (max-width: 700px) {
      header {
        flex-wrap:wrap;
        align-items:flex-start;
      }
      nav {
        width:100%;
        justify-content:flex-start;
        margin-top:4px;
      }
      nav a {
        padding:6px 8px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.35);
        background:#020617;
        font-size:12px;
      }

      .layout {
        grid-template-columns:1fr;
      }

      .table thead {
        display:none;
      }
      .table,
      .table tbody,
      .table tr,
      .table td {
        display:block;
        width:100%;
      }
      .table tr {
        border-bottom:1px solid #e5e7eb;
        padding:6px 0;
      }
      .table td {
        border:none;
        padding:4px 0;
      }

      .cell-no,
      .cell-nick,
      .cell-stats,
      .cell-time {
        display:none;
      }

      .cell-body .m-line1 {
        display:-webkit-box;
        -webkit-line-clamp:2;
        -webkit-box-orient:vertical;
        overflow:hidden;
        white-space:normal;
      }
      .cell-body .m-line2 {
        justify-content:flex-end;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo_small.png"
         alt="Measure Master logo"
         class="logo-img"
         width="28" height="28"
         loading="eager" fetchpriority="high" />
    <strong>Measure Master</strong>
    <span class="brand-sub">User reviews</span>
  </div>
  <nav>
    <a href="/">Home</a>
    <a href="/howtouse.html">How to use</a>
    <a href="/reviews.html" aria-current="page">Reviews</a>
    <a href="/privacy.html">Privacy</a>
  </nav>
</header>

<main>
  <div class="layout">
    <!-- Left: login status -->
    <section class="card" id="leftAuth">
      <h2>Login status</h2>
      <p id="authStatus">Checking login status…</p>
      <p class="hint">
        To write or edit a review, please sign up / log in on the home page
        (the Tester login section at the bottom of the main page).
      </p>
    </section>

    <!-- Right: list + write form -->
    <section class="card" id="rightCard">
      <h1>User reviews</h1>
      <p class="muted" id="authInfo">Checking login status…</p>

      <!-- List view -->
      <div id="listView">
        <table class="table">
          <thead>
          <tr>
            <th class="cell-no">No.</th>
            <th class="cell-nick">Nickname</th>
            <th>Title & summary</th>
            <th class="cell-stats">Views</th>
            <th class="cell-time">Created at</th>
          </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>

        <div class="list-footer">
          <button type="button" class="btn" id="btn-compose">
            Write a review
          </button>
        </div>
        <p id="listLoginHint">
          To write a review, please sign up / log in on the home page.
        </p>
      </div>

      <!-- Write form -->
      <form id="writeForm" hidden>
        <div class="field">
          <label for="title">Title</label>
          <input id="title" type="text" placeholder="Short title for your review" required />
        </div>
        <div class="field">
          <label for="content">Content</label>
          <textarea id="content"
                    placeholder="Write your feedback about Measure Master."
                    required></textarea>
        </div>

        <div class="write-actions">
          <span id="formStatus"></span>
          <button type="button" class="btn secondary" id="btn-cancel">
            Back to list
          </button>
          <button type="submit" class="btn">
            Save review
          </button>
        </div>
      </form>
    </section>
  </div>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<!-- Supabase + shared auth + reviews UI -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/mm-auth.js?v=auth_r2"></script>
<script src="/js/reviews-ui.js?v=rev17"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('[reviews] DOM ready');

    // Footer year
    const y = document.getElementById('year');
    if (y) y.textContent = new Date().getFullYear();

    const authInfoEl = document.getElementById('authInfo');
    const authStatusEl = document.getElementById('authStatus');
    const setStatus = (text) => {
      if (authInfoEl) authInfoEl.textContent = text;
      if (authStatusEl) authStatusEl.textContent = text;
    };

    if (!window.mmAuth || !window.mmAuth.supabase) {
      console.error('[reviews] mmAuth or supabase client not found.');
      setStatus('Auth client not found. Please reload the page.');
      return;
    }

    const client = window.mmAuth.supabase;
    let user = null;

    try {
      const { data, error } = await client.auth.getUser();
      console.log('[reviews] getUser result:', data, error);

      if (error) {
        if (error.name === 'AuthSessionMissingError') {
          console.log('[reviews] No auth session (not logged in).');
          setStatus('You are not logged in. To write a review, please log in on the home page.');
        } else {
          console.error('[reviews] getUser error:', error);
          setStatus('Error while checking login status.');
        }
      } else if (data && data.user) {
        user = data.user;
        setStatus('Logged in as: ' + (user.email || ''));
        document.body.classList.add('is-logged-in');
      } else {
        setStatus('You are not logged in. To write a review, please log in on the home page.');
        document.body.classList.remove('is-logged-in');
      }
    } catch (e) {
      console.error('[reviews] auth init exception:', e);
      setStatus('Error while checking login status.');
    }

    if (window.MMReviews && typeof window.MMReviews.init === 'function') {
      await window.MMReviews.init(client, user);
    } else {
      console.error('[reviews] MMReviews.init not found.');
    }
  });
</script>
</body>
</html>
