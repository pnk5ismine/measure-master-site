<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — Reviews</title>
  <meta name="description" content="User reviews for Measure Master." />

  <link rel="icon" type="image/png" href="/images/mm_logo.png" />
  <link rel="preload" as="image" href="/images/mm_logo.png" />

  <style>
    :root {
      --bg:#050816;
      --card:#0f172a;
      --border:#1e2230;
      --muted:#9aa4b2;
      --text:#e7edf5;
      --accent:#5eead4;
      --accent-soft:rgba(94,234,212,.1);
      --danger:#f97373;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif;
      background:radial-gradient(circle at 0 0, rgba(94,234,212,.23), transparent 55%),
                 radial-gradient(circle at 100% 100%, rgba(59,130,246,.18), transparent 55%),
                 var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    header,main,footer{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }

    /* Header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-img{
      width:28px;
      height:28px;
      border-radius:6px;
      object-fit:contain;
      background:#0e1422;
      box-shadow:0 0 0 1px rgba(148,163,184,.4), 0 8px 24px rgba(15,23,42,.9);
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-text strong{
      font-size:18px;
      letter-spacing:-0.02em;
    }
    .brand-sub{
      font-size:11px;
      color:var(--muted);
    }

    nav{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:13px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    nav a{
      color:#cfd6e4;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    nav a:hover{
      border-color:rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      text-decoration:none;
    }
    nav a[aria-current="page"]{
      border-color:rgba(94,234,212,.7);
      background:rgba(15,23,42,.96);
      color:var(--accent);
      font-weight:600;
    }

    main{
      flex:1;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 18px 45px rgba(15,23,42,.85);
    }

    h1{
      margin:0 0 8px;
      font-size:20px;
      letter-spacing:-0.02em;
    }
    .muted{
      color:var(--muted);
      font-size:13px;
      margin:0 0 10px;
    }

    /* Table/list */
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{
      border-bottom:1px solid #1e293b;
      padding:8px 6px;
      vertical-align:top;
    }
    .table th{
      text-align:left;
      color:#e2e8f0;
      font-weight:500;
      font-size:13px;
    }
    .table tr:hover{background:#020617}
    .cell-no{width:50px;color:#94a3b8}
    .cell-nick{width:110px;}
    .cell-stats{width:80px;text-align:center;color:#94a3b8}
    .cell-time{width:150px;text-align:right;color:#94a3b8}
    .cell-body{
      word-break:break-word;
    }
    .cell-body .m-line1{
      font-weight:600;
      margin-bottom:4px;
    }
    .cell-body .m-line2{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:#94a3b8;
    }
    .notice-tag{
      color:#38bdf8;
      font-weight:700;
      margin-right:4px;
      font-size:12px;
    }
    tr.notice .cell-body .m-line1{
      color:#38bdf8;
    }

    .list-footer{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      margin-top:10px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:#020617;
      color:var(--text);
      font-size:13px;
      cursor:pointer;
    }
    .btn-primary{
      border-color:rgba(94,234,212,.7);
      background:rgba(15,23,42,.98);
      color:var(--accent);
      font-weight:600;
    }
    .btn-danger{
      border-color:rgba(248,113,113,.7);
      background:rgba(127,29,29,.9);
      color:#fee2e2;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:default;
    }

    /* Write form */
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin:8px 0;
      font-size:13px;
    }
    .field label{
      color:#e2e8f0;
    }
    input[type="text"], textarea{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:13px;
    }
    textarea{
      min-height:120px;
      resize:vertical;
    }
    input[type="file"]{
      color:#e2e8f0;
      font-size:12px;
    }
    .status{
      font-size:12px;
      color:var(--muted);
    }

    .thumbs{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }
    .thumb-card{
      border-radius:10px;
      overflow:hidden;
      border:1px solid #1e293b;
      background:#020617;
    }
    .thumb-card img{
      width:100%;
      height:100px;
      object-fit:cover;
      display:block;
    }

    /* Read view */
    #readView h2{
      margin:0 0 4px;
      font-size:18px;
    }
    .read-meta{
      font-size:12px;
      color:#94a3b8;
      margin-bottom:10px;
    }
    .read-content{
      font-size:14px;
      line-height:1.6;
      white-space:pre-wrap;
      word-break:break-word;
      margin-bottom:12px;
    }

    .read-images{
      margin:10px 0 14px;
    }
    .read-images .thumbs .thumb-card img{
      height:120px;
      cursor:pointer;
    }

    .like-bar{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 0 16px;
      padding:8px 10px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1e293b;
      font-size:13px;
    }
    .like-count{
      font-size:13px;
      color:#e2e8f0;
    }

    /* Comments */
    .comments{
      margin-top:16px;
      padding-top:10px;
      border-top:1px solid #1f2937;
    }
    .comments h3{
      margin:0 0 8px;
      font-size:15px;
    }
    .comment-list{
      margin:0;
      padding:0;
      list-style:none;
    }
    .comment-item{
      border-bottom:1px solid #1f2937;
      padding:8px 0;
      font-size:13px;
    }
    .comment-head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
      color:#94a3b8;
      font-size:12px;
    }
    .comment-body{
      white-space:pre-wrap;
      word-break:break-word;
    }
    .comment-actions{
      text-align:right;
      font-size:11px;
      margin-top:4px;
    }
    .comment-actions button{
      background:none;
      border:none;
      color:#f97373;
      cursor:pointer;
    }

    .comment-form{
      margin-top:10px;
      padding-top:8px;
      border-top:1px dashed #1f2937;
    }

    footer{
      margin:30px auto 40px;
      padding:0 16px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }

    @media (max-width:720px){
      header{
        flex-wrap:wrap;
        align-items:flex-start;
      }
      nav{
        width:100%;
        justify-content:flex-start;
      }
      .table th,.table td{
        font-size:12px;
      }
      .thumbs{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/images/mm_logo.png"
         alt="Measure Master"
         class="logo-img"
         onerror="this.onerror=null;this.src='/images/mm_logo.png';" />
    <div class="brand-text">
      <strong>Measure Master</strong>
      <div class="brand-sub">3-in-1 measuring tool</div>
    </div>
  </div>
  <nav>
    <a href="/">Home</a>
    <a href="/howtouse.html">How to use</a>
    <a href="/reviews.html" aria-current="page">Reviews</a>
    <a href="/privacy.html">Privacy</a>
  </nav>
</header>

<main>
  <section class="card">
    <h1>User reviews</h1>
    <p id="authInfo" class="muted">Checking login status…</p>

    <!-- 목록 뷰 -->
    <div id="listView">
      <table class="table">
        <thead>
        <tr>
          <th class="cell-no">No.</th>
          <th class="cell-nick">Nickname</th>
          <th>Title & preview</th>
          <th class="cell-stats">Views</th>
          <th class="cell-time">Date</th>
        </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
      <div class="list-footer">
        <span id="listLoginHint" class="status">
          To write a review, please sign up / log in on the home page.
        </span>
        <button id="btn-compose" class="btn btn-primary" type="button">
          Write a review
        </button>
      </div>
    </div>

    <!-- 읽기 뷰 -->
    <article id="readView" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
        <button type="button" id="btn-back-list" class="btn">← Back to list</button>
        <div>
          <button type="button" id="btn-edit-review" class="btn" style="display:none;">Edit</button>
          <button type="button" id="btn-delete-review" class="btn btn-danger" style="display:none;">Delete</button>
        </div>
      </div>

      <h2 id="readTitle"></h2>
      <div class="read-meta" id="readMeta"></div>
      <div class="read-content" id="readContent"></div>

      <div class="read-images" id="readImages" hidden>
        <div class="thumbs" id="readImagesGrid"></div>
      </div>

      <div class="like-bar">
        <button type="button" id="btn-like" class="btn">
          ❤️ Like
        </button>
        <span class="like-count">
          <span id="likeCount">0</span> likes
        </span>
      </div>

      <div class="comments" id="comments">
        <h3>Comments</h3>
        <ul class="comment-list" id="commentsList"></ul>

        <form id="commentForm" class="comment-form">
          <div class="field">
            <label for="commentContent">Add a comment</label>
            <textarea id="commentContent" placeholder="Write your comment here…"></textarea>
          </div>
          <div style="display:flex;justify-content:flex-end;align-items:center;gap:8px;">
            <span id="commentStatus" class="status" style="margin-right:auto;"></span>
            <button type="submit" class="btn btn-primary">Post comment</button>
          </div>
        </form>
      </div>
    </article>

    <!-- 글쓰기 뷰 -->
    <form id="writeForm" hidden>
      <h2 id="writeTitleHeading">Write a new review</h2>

      <div class="field">
        <label for="title">Title</label>
        <input id="title" type="text" placeholder="Short summary of your experience" required />
      </div>

      <div class="field">
        <label for="content">Content</label>
        <textarea id="content" placeholder="Please write your experience with Measure Master." required></textarea>
      </div>

      <div class="field">
        <label for="review-images">
          Attach images (optional, up to 6)
        </label>
        <input id="review-images" type="file" accept="image/*" multiple />
        <div id="selectPreviews" class="thumbs"></div>
        <div class="status">
          Images are uploaded to Supabase Storage. Large images may be resized by the browser or your device.
        </div>
      </div>

      <div style="border-top:1px solid #1e293b;margin-top:12px;padding-top:10px;display:flex;align-items:center;gap:8px;justify-content:flex-end;">
        <span id="formStatus" class="status" style="margin-right:auto;"></span>
        <button type="button" id="btn-cancel-write" class="btn">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </section>
</main>

<footer>
  © <span id="year"></span> Measure Master. All rights reserved.
</footer>

<!-- Supabase & JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/mm-auth.js?v=auth_r2"></script>
<script src="/js/reviews-ui.js?v=rev18"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    // Footer year
    const y = document.getElementById('year');
    if (y) y.textContent = new Date().getFullYear();

    const client = window.mmAuth?.supabase || null;
    let currentUser = null;

    if (client && client.auth) {
      try {
        const { data, error } = await client.auth.getUser();
        console.log('[reviews] getUser result:', { data, error });
        if (!error && data && data.user) {
          currentUser = data.user;
        }
      } catch (e) {
        console.warn('[reviews] getUser error:', e);
      }
    }

    if (window.MMReviews) {
      await window.MMReviews.init(client, currentUser);
    } else {
      console.error('[reviews] MMReviews not loaded');
    }
  });
</script>
</body>
</html>
