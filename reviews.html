<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Measure Master — Reviews</title>

  <style>
    :root{
      --bg:#050816;
      --text:#e7edf5;
      --muted:#9aa4b2;

      --panel-bg:#ffffff;
      --panel-text:#111827;
      --panel-muted:#6b7280;
      --panel-border:#d1d5db;

      --danger:#dc2626;

      /* Notice */
      --notice:#1d4ed8;
      --notice-bg:#eff6ff;
      --notice-bg-hover:#dbeafe;
      --notice-border:#93c5fd;
      --notice-badge-bg:#dbeafe;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif;
      background:
        radial-gradient(circle at 0 0, rgba(94,234,212,.23), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(59,130,246,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .page{max-width:1180px;margin:0 auto;padding:16px 16px 40px;}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:6px 0 10px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo-img{
      width:32px;height:32px;border-radius:10px;object-fit:contain;
      background:#0e1422;
      box-shadow:0 0 0 1px rgba(148,163,184,.4), 0 10px 35px rgba(15,23,42,.9);
    }
    nav{display:flex;align-items:center;gap:12px;font-size:13px;flex-wrap:wrap;justify-content:flex-end;}
    nav a{
      color:#cdd5f0;padding:6px 10px;border-radius:999px;border:1px solid transparent;
      white-space:nowrap;text-decoration:none;
    }
    nav a:hover{border-color:rgba(148,163,184,.5);background:rgba(15,23,42,.86);}
    nav a[aria-current="page"]{
      border-color:rgba(94,234,212,.7);
      background:rgba(15,23,42,.96);
      color:#5eead4;
      font-weight:700;
    }

    .card{
      background:var(--panel-bg);
      color:var(--panel-text);
      border:1px solid rgba(30,64,175,.35);
      border-radius:22px;
      padding:18px;
      box-shadow:0 18px 55px rgba(15,23,42,.35);
    }

    h1{margin:0 0 8px;font-size:20px;color:var(--panel-text);}
    h2{margin:0 0 8px;font-size:18px;color:var(--panel-text);}
    h3{margin:18px 0 10px;font-size:15px;color:var(--panel-text);}
    .muted{color:var(--panel-muted);}
    .status{font-size:12px;color:var(--panel-muted);margin-top:4px;}

    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0;}
    label{font-size:13px;color:var(--panel-text);}
    input[type="text"], textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--panel-border);
      background:#fff;
      color:var(--panel-text);
      font-size:14px;
    }
    textarea{min-height:160px;resize:vertical;}
    input[type="file"]{display:block;font-size:13px;}

    .btn{
      padding:8px 13px;border-radius:10px;
      border:1px solid #2563eb;background:#2563eb;color:#fff;
      cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:6px;
    }
    .btn.secondary{background:#f9fafb;color:#111827;border:1px solid #d1d5db;}
    .btn.danger{border-color:var(--danger);background:var(--danger);color:#fff;}
    .btn:hover{filter:brightness(1.03);}

    /* Table fixed width (내용량에 따라 흔들리지 않음) */
    .table{width:100%;border-collapse:collapse;table-layout:fixed;background:#fff;}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px 8px;vertical-align:top;}
    .table th{font-weight:700;color:#111827;text-align:left;background:#f9fafb;}
    .table tr:hover td{background:#f3f4f6;}

    .cell-no{width:56px;color:#6b7280;}
    .cell-nick{width:110px;}
    .cell-stats{width:90px;text-align:center;color:#6b7280;}
    .cell-time{width:170px;color:#6b7280;text-align:right;}
    .cell-body{width:auto;}

    .row-link{display:block;text-decoration:none;color:inherit;}
    .row-link:hover{text-decoration:none;}

    .title-row{display:flex;align-items:center;gap:8px;min-width:0;margin-bottom:4px;}
    .list-title{
      font-weight:800;color:#111827;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;
    }
    .list-preview{
      color:#374151;word-break:break-word;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;line-height:1.35;margin-bottom:6px;
    }
    .list-meta{
      display:flex;justify-content:space-between;gap:10px;
      font-size:12px;color:#6b7280;
    }

    /* ✅ Notice badge: 다른 CSS가 있어도 절대 안 밀리게 !important */
    .notice-badge{
      display:inline-flex;align-items:center;flex:0 0 auto;
      font-size:11px;font-weight:900;letter-spacing:.02em;
      padding:2px 8px;border-radius:999px;
      color:var(--notice) !important;
      background:var(--notice-badge-bg) !important;
      border:1px solid var(--notice-border) !important;
      box-shadow:0 2px 10px rgba(29,78,216,.18) !important;
    }

    /* ✅ Notice row highlight */
    .table tr.notice td{ background:var(--notice-bg) !important; }
    .table tr.notice:hover td{ background:var(--notice-bg-hover) !important; }

    /* ✅ Notice: 제목/프리뷰/메타(날짜 포함)/우측 날짜칸까지 모두 파랑 */
    .table tr.notice .list-title,
    .table tr.notice .list-preview,
    .table tr.notice .list-meta,
    .table tr.notice .cell-time,
    .table tr.notice .cell-stats,
    .table tr.notice .cell-nick{
      color:var(--notice) !important;
    }

    /* Read view: notice면 본문까지 파랑 */
    #readView.notice-read h2,
    #readView.notice-read .read-meta,
    #readView.notice-read .read-content{
      color:var(--notice) !important;
    }

    /* Thumbnails */
    .thumbs{
      display:grid;
      grid-template-columns:repeat(6,minmax(0,1fr));
      gap:8px;margin-top:8px;
    }
    @media (max-width:768px){
      .thumbs{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    .thumb-card{
      width:100%;aspect-ratio:9/16;border-radius:10px;overflow:hidden;
      background:#f9fafb;border:1px solid #e5e7eb;
    }
    .thumb-img{width:100%;height:100%;object-fit:cover;display:block;}

    .top-actions{
      border-bottom:1px solid #e5e7eb;
      padding-bottom:10px;margin-bottom:12px;
      display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .read-meta{margin:6px 0 12px;font-size:13px;color:#6b7280;}
    .read-content{white-space:pre-wrap;word-break:break-word;color:#111827;line-height:1.55;}

    .comment-item{border-top:1px solid #e5e7eb;padding:10px 0;}
    .comment-head{font-size:13px;color:#6b7280;display:flex;justify-content:space-between;gap:8px;}
    .comment-body{white-space:pre-wrap;word-break:break-word;margin-top:6px;color:#111827;line-height:1.45;}
    .comment-form{display:flex;gap:8px;margin-top:10px;align-items:flex-start;}
    .comment-form textarea{flex:1;min-height:70px;}

    .list-footer{
      border-top:1px solid #e5e7eb;padding-top:10px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      margin-top:10px;flex-wrap:wrap;
    }

    @media (max-width:700px){
      .table thead{display:none;}
      .table,.table tbody,.table tr,.table td{display:block;width:100%;}
      .table tr{border-bottom:1px solid #e5e7eb;padding:6px 0;}
      .table td{border:none;padding:6px 8px;}
      .cell-no,.cell-nick,.cell-stats,.cell-time{display:none;}
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <img src="/images/mm_logo.png" alt="Measure Master" class="logo-img" />
        <div>
          <div style="font-weight:800;letter-spacing:-0.02em;">Measure Master</div>
          <div style="font-size:11px;color:var(--muted);">3-in-1 measuring tool</div>
        </div>
      </div>
      <nav>
        <a href="/">Home</a>
        <a href="/howtouse.html">How to use</a>
        <a href="/reviews.html" aria-current="page">Reviews</a>
        <a href="/privacy.html">Privacy</a>
      </nav>
    </header>

    <main>
      <section class="card">
        <h1>User reviews</h1>
        <p id="authInfo" class="muted">Checking login status…</p>

        <div id="listView">
          <table class="table">
            <thead>
              <tr>
                <th class="cell-no">No.</th>
                <th class="cell-nick">Nickname</th>
                <th>Title & preview</th>
                <th class="cell-stats">Views</th>
                <th class="cell-time">Date</th>
              </tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>

          <div class="list-footer">
            <span id="listLoginHint" class="status">
              To write a review, please sign up / log in on the home page.
            </span>
            <button id="btn-compose" class="btn" type="button">Write a review</button>
          </div>
        </div>

        <article id="readView" hidden></article>

        <form id="writeForm" hidden>
          <h2>Write a new review</h2>

          <div id="noticeField" class="field" style="display:none;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input id="isNotice" type="checkbox" />
              <span>Post as Notice (admin only)</span>
            </label>
            <div class="status">Notice posts are pinned to the top and shown in blue.</div>
          </div>

          <div class="field">
            <label for="title">Title</label>
            <input id="title" type="text" required />
          </div>

          <div class="field">
            <label for="content">Content</label>
            <textarea id="content" required></textarea>
          </div>

          <div class="field">
            <label for="image">Attach images (optional, up to 6)</label>
            <input id="image" type="file" accept="image/*" multiple data-max="6" />
            <div id="selectPreviews" class="thumbs"></div>
          </div>

          <div style="border-top:1px solid #e5e7eb;margin-top:12px;padding-top:10px;display:flex;align-items:center;gap:8px;justify-content:flex-end;">
            <span id="formStatus" class="status" style="margin-right:auto;"></span>
            <button type="button" id="btn-cancel-write" class="btn secondary">Cancel</button>
            <button type="submit" class="btn">Save</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/mm-auth.js?v=auth_r3"></script>
  <script src="/js/reviews-ui.js?v=rev23"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const client = window.mmAuth?.supabase || null;
      let currentUser = null;

      if (client && client.auth) {
        try {
          const { data, error } = await client.auth.getUser();
          console.log('[reviews] getUser result:', { data, error });
          if (!error && data && data.user) currentUser = data.user;
        } catch (e) {
          console.warn('[reviews] getUser error:', e);
        }
      }

      const authInfo = document.getElementById('authInfo');
      if (authInfo) {
        authInfo.textContent = currentUser
          ? `Logged in as ${currentUser.email}`
          : 'Not logged in. Please sign up / log in on the home page to write.';
      }

      if (window.MMReviews) {
        await window.MMReviews.init(client, currentUser);
      } else {
        console.error('[reviews] MMReviews not loaded');
      }
    });
  </script>
</body>
</html>
